<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Precios</title>
    <!-- Tailwind CSS CDN -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/3.4.3/tailwind.min.css" rel="stylesheet">
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* ðŸ”µ Estilos modernos personalizados */
        :root {
            --color-bg-card: #f9fbff;
            --color-border-card: #dbeafe;
            --color-accent: #3b82f6; /* Tailwind blue-500 */
            --color-accent-hover: #2563eb; /* Tailwind blue-600 */
            --color-text-primary: #1e293b; /* Tailwind slate-800 */
            --color-shadow: rgba(59, 130, 246, 0.15); /* Shadow based on accent color */
        }

        body {
            font-family: 'Inter', sans-serif;
            color: var(--color-text-primary);
            background-color: #f3f4f6; /* Light gray background for the whole page */
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        h1, h2, h3 {
            font-weight: 700; /* Bold */
            color: var(--color-accent); /* Accent color for headings */
        }

        /* Custom shadows for better visual appeal */
        .shadow-custom-light {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .shadow-custom-medium {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .shadow-custom-strong {
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.1), 0 10px 10px rgba(0, 0, 0, 0.04);
        }
        .text-shadow-lg {
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Card Modern Style */
        .card-modern {
            background-color: var(--color-bg-card);
            border: 1px solid var(--color-border-card);
            border-radius: 1rem; /* Rounded corners */
            box-shadow: 0 8px 16px var(--color-shadow); /* Soft shadow */
            padding: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease; /* Smooth hover effects */
        }
        .card-modern:hover {
            transform: translateY(-4px); /* Slight lift on hover */
            box-shadow: 0 12px 24px rgba(59, 130, 246, 0.25); /* Enhanced shadow on hover */
        }

        /* Button Modern Style */
        .btn-modern {
            background-color: var(--color-accent);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .btn-modern:hover {
            background-color: var(--color-accent-hover);
            transform: scale(1.02); /* Slight scale for button hover */
        }

        /* Excel-like Table Appearance */
        .excel-table {
            border-collapse: collapse; /* Ensures single borders */
            width: 100%;
        }
        .excel-table th {
            white-space: normal; /* Allow text wrapping in headers */
            vertical-align: middle; /* Center text vertically in headers */
            text-align: center; /* Center align headers by default */
            word-break: break-word; /* Ensure long words break */
            min-width: 80px; /* Minimum width for columns to encourage wrapping */
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }
        .excel-table th, .excel-table td {
            border: 1px solid #cce0f0; /* Slightly darker light blue border for all cells */
            padding: 0.75rem 0.8rem; /* Consistent padding, slightly less horizontal for more columns */
        }
        .excel-table thead th {
            background-color: #eaf3fa; /* Lighter blue background for headers */
            font-weight: 600; /* Semi-bold headers */
            color: #2a6592; /* Darker blue text for headers */
            text-transform: uppercase;
            font-size: 0.8rem; /* Slightly smaller font for headers to fit more text */
        }
        .excel-table tbody tr:nth-child(even) {
            background-color: #f8fafc; /* Lighter alternating row color */
        }
        .excel-table tbody tr:hover {
            background-color: #e0f0ff; /* Subtle hover effect with light blue */
        }
        /* Specific alignment for price columns in tbody */
        .excel-table tbody td.text-right {
            font-family: 'Inter', sans-serif; /* Ensure consistent font */
            font-weight: 500; /* Slightly bolder for numbers */
            color: #333; /* Darker color for numbers */
        }

        /* Responsive adjustments for table cells */
        @media (max-width: 640px) {
            .table-cell-responsive {
                font-size: 0.75rem; /* Smaller font on small screens */
                padding: 0.5rem 0.75rem; /* Adjust padding */
            }
        }

        /* Print specific styles */
        @media print {
            body * {
                visibility: hidden; /* Hide everything by default */
            }
            #print-area, #print-area * {
                visibility: visible; /* Show only the print area */
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px;
                box-sizing: border-box;
            }
            /* Adjust table styles for print */
            #print-area .excel-table {
                width: 100%;
                border-collapse: collapse;
            }
            #print-area .excel-table th,
            #print-area .excel-table td {
                border: 1px solid #ccc;
                padding: 8px;
                font-size: 10px; /* Smaller font for print */
                text-align: left;
                white-space: normal; /* Allow text wrapping */
            }
            #print-area .excel-table th {
                background-color: #f2f2f2;
                font-weight: bold;
                color: #333;
            }
            #print-area .excel-table tbody tr:nth-child(even) {
                background-color: #f9f9f9;
            }
            #print-area .excel-table tbody td.text-right {
                text-align: right;
            }
            /* Hide print button in print view */
            .no-print {
                display: none;
            }
        }
    </style>

    <!-- React CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel CDN (for JSX transformation in the browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- PapaParse CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Firebase CDN -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase (will be available in the React component scope)
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.firebaseInitialized = false;
        window.appId = 'default-app-id';
        window.globalFirebaseError = null;
        window.isFirebaseInitializingGlobally = true;

        // Expose Firestore functions globally for the Babel script to use
        window.collection = collection;
        window.onSnapshot = onSnapshot;
        window.addDoc = addDoc;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;

        // Initialize Firebase and authenticate
        const initFirebase = async () => {
            if (window.firebaseInitialized || window.globalFirebaseError || !window.isFirebaseInitializingGlobally) {
                console.log("Firebase already initialized, failed, or stopped. Skipping re-initialization.");
                return;
            }

            console.log("Starting Firebase initialization...");

            try {
                let firebaseConfig = {};
                let currentAppId = 'default-app-id';

                if (typeof __firebase_config !== 'undefined') {
                    firebaseConfig = JSON.parse(__firebase_config);
                    currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    console.log("Firebase Config (from Canvas):", firebaseConfig);
                } else {
                    // !!! IMPORTANT: REPLACE THE VALUES BELOW WITH YOUR ACTUAL FIREBASE CONFIGURATION !!!
                    firebaseConfig = {
                        apiKey: "AIzaSyBfCD3_opZniAHRXat42APlrhHwh_BpGPg",
                        authDomain: "lista-de-precios-3d4df.firebaseapp.com",
                        projectId: "lista-de-precios-3d4df",
                        storageBucket: "lista-de-precios-3d4df.firebasestorage.app",
                        messagingSenderId: "561816433633",
                        appId: "1:561816433633:web:64312f4928ae92c40d58a0",
                        measurementId: "G-GKQWC526ET"
                    };
                    currentAppId = firebaseConfig.projectId || 'default-app-id';

                    console.warn("ADVERTENCIA: Usando configuraciÃ³n de Firebase hardcodeada. Recuerda reemplazar los marcadores de posiciÃ³n con los detalles reales de tu proyecto de Firebase para el despliegue en producciÃ³n.");
                    console.log("Firebase Config (hardcodeada):", firebaseConfig);
                }

                if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey === 'YOUR_FIREBASE_API_KEY' || firebaseConfig.apiKey === '') {
                    throw new Error("Firebase API Key is missing or invalid in the configuration. Please replace 'YOUR_FIREBASE_API_KEY' with your actual key from Firebase Console.");
                }

                const app = initializeApp(firebaseConfig);
                console.log("Firebase app initialized.");
                const authInstance = getAuth(app);
                console.log("Firebase auth obtained.");
                const dbInstance = getFirestore(app);
                console.log("Firebase firestore obtained.");

                window.firebaseApp = app;
                window.db = dbInstance;
                window.auth = authInstance;
                window.appId = currentAppId;

                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(window.auth, __initial_auth_token);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(window.auth);
                    console.log("Signed in anonymously.");
                }

                window.firebaseInitialized = true;
                console.log("Firebase initialized and authenticated successfully.");

            } catch (e) {
                console.error("Error al inicializar Firebase o iniciar sesiÃ³n:", e);
                window.globalFirebaseError = `Error crÃ­tico al inicializar Firebase: ${e.message}. Por favor, revisa la consola del navegador.`;
            } finally {
                window.isFirebaseInitializingGlobally = false;
            }
        };

        // Call initialization on script load
        initFirebase();
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- UTILITY FUNCTIONS ---
        // Function to clean and parse numerical values from CSV
        const cleanAndParseFloat = (value) => {
            if (typeof value !== 'string') {
                return parseFloat(value) || 0;
            }
            let cleanedValue = value.replace(/[^\d.,-]/g, '');
            const hasComma = cleanedValue.includes(',');
            const hasDot = cleanedValue.includes('.');

            if (hasComma && hasDot) {
                if (cleanedValue.indexOf(',') > cleanedValue.indexOf('.')) {
                    cleanedValue = cleanedValue.replace(/\./g, '');
                    cleanedValue = cleanedValue.replace(/,/g, '.');
                } else {
                    cleanedValue = cleanedValue.replace(/,/g, '');
                }
            } else if (hasComma) {
                cleanedValue = cleanedValue.replace(/,/g, '.');
            }
            const parsed = parseFloat(cleanedValue);
            return isNaN(parsed) ? 0 : parsed;
        };

        // Function to load CSV from a given URL
        const loadCsvFromUrl = async (url, setPriceData, setError, initialMockPriceData, Papa) => {
            setError(null);
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Error al cargar el CSV: ${response.statusText} (${response.status}). AsegÃºrate de que la URL sea correcta y el archivo sea accesible.`);
                }
                const csvText = await response.text();

                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        const requiredHeaders = [
                            'Tipo Equipo', 'Marca', 'Equipo', 'Codigo SAP', 'Color',
                            'Precio Publico (IVA incluido)', 'PrecioFacturacion distribuidor (con sim e IVA Incluido)',
                            'Precio subdistribuidor (IVA Incluido)', 'Inicio de Vigencia', 'Fin de Vigencia', 'Utilidad DS'
                        ];
                        const actualHeaders = results.meta.fields;
                        const missingHeaders = requiredHeaders.filter(header => !actualHeaders.includes(header));

                        if (missingHeaders.length > 0) {
                            setError(`Error en el CSV: Faltan las siguientes columnas: ${missingHeaders.join(', ')}. AsegÃºrate de que los nombres de las columnas coincidan exactamente.`);
                            setPriceData(initialMockPriceData);
                            return;
                        }

                        const parsedData = results.data.map((row, index) => {
                            const item = {
                                id: index + 1,
                                'Tipo Equipo': row['Tipo Equipo'],
                                Marca: row['Marca'],
                                Equipo: row['Equipo'],
                                'Codigo SAP': row['Codigo SAP'],
                                Color: row['Color'],
                                'Precio Publico (IVA incluido)': cleanAndParseFloat(row['Precio Publico (IVA incluido)']),
                                'PrecioFacturacion distribuidor (con sim e IVA Incluido)': cleanAndParseFloat(row['PrecioFacturacion distribuidor (con sim e IVA Incluido)']),
                                'Precio subdistribuidor (IVA Incluido)': cleanAndParseFloat(row['Precio subdistribuidor (IVA Incluido)']),
                                'Inicio de Vigencia': row['Inicio de Vigencia'],
                                'Fin de Vigencia': row['Fin de Vigencia'],
                                'Utilidad DS': cleanAndParseFloat(row['Utilidad DS']),
                            };
                            return item;
                        });

                        if (parsedData.length > 0) {
                            setPriceData(parsedData);
                            setError(null);
                        } else {
                            setError('El archivo CSV estÃ¡ vacÃ­o o no contiene datos vÃ¡lidos.');
                            setPriceData(initialMockPriceData);
                        }
                    },
                    error: (err) => {
                        setError(`Error al parsear el archivo CSV: ${err.message}`);
                        setPriceData(initialMockPriceData);
                    }
                });
            } catch (err) {
                setError(`Error de red o CORS: ${err.message}. AsegÃºrate de que la URL sea pÃºblica y accesible.`);
                setPriceData(initialMockPriceData);
            }
        };

        // --- CONSTANTS ---
        const initialMockPriceData = [
          { id: 1, 'Tipo Equipo': 'Laptop', Marca: 'Acer', Equipo: 'Nitro 5', 'Codigo SAP': 'ACN5-001', Color: 'Negro', 'Precio Publico (IVA incluido)': 1500, 'PrecioFacturacion distribuidor (con sim e IVA Incluido)': 1200, 'Precio subdistribuidor (IVA Incluido)': 1000, 'Inicio de Vigencia': '2024-01-01', 'Fin de Vigencia': '2024-12-31', 'Utilidad DS': 0.20 },
          { id: 2, 'Tipo Equipo': 'Monitor', Marca: 'Samsung', Equipo: 'Odyssey G7', 'Codigo SAP': 'SMOG7-002', Color: 'Negro', 'Precio Publico (IVA incluido)': 400, 'PrecioFacturacion distribuidor (con sim e IVA Incluido)': 350, 'Precio subdistribuidor (IVA Incluido)': 300, 'Inicio de Vigencia': '2024-01-01', 'Fin de Vigencia': '2024-12-31', 'Utilidad DS': 0.15 },
        ];

        const allColumns = [
            { key: 'Tipo Equipo', label: 'Tipo Equipo', align: 'left' },
            { key: 'Marca', label: 'Marca', align: 'left' },
            { key: 'Equipo', label: 'Equipo', align: 'left' },
            { key: 'Codigo SAP', label: 'CÃ³digo SAP', align: 'left' },
            { key: 'Color', label: 'Color', align: 'left' },
            { key: 'Precio Publico (IVA incluido)', label: 'Precio PÃºblico (IVA incluido)', align: 'right' },
            { key: 'PrecioFacturacion distribuidor (con sim e IVA Incluido)', label: 'Precio FacturaciÃ³n Distribuidor (con sim e IVA Incluido)', align: 'right' },
            { key: 'Precio subdistribuidor (IVA Incluido)', label: 'Precio Subdistribuidor (IVA Incluido)', align: 'right' },
            { key: 'Inicio de Vigencia', label: 'Inicio de Vigencia', align: 'left' },
            { key: 'Fin de Vigencia', label: 'Fin de Vigencia', align: 'left' },
            { key: 'Utilidad DS', label: 'Utilidad DS', align: 'right' }
        ];

        const columnVisibility = {
            admin: [
                'Tipo Equipo', 'Marca', 'Equipo', 'Codigo SAP', 'Color',
                'Precio Publico (IVA incluido)', 'PrecioFacturacion distribuidor (con sim e IVA Incluido)',
                'Precio subdistribuidor (IVA Incluido)', 'Inicio de Vigencia', 'Fin de Vigencia', 'Utilidad DS'
            ],
            direccion: [
                'Marca', 'Equipo', 'Codigo SAP', 'Color',
                'Precio Publico (IVA incluido)', 'Precio subdistribuidor (IVA Incluido)',
                'Inicio de Vigencia', 'Fin de Vigencia', 'Utilidad DS'
            ],
            distribuidor: [
                'Marca', 'Equipo', 'Codigo SAP', 'Color',
                'Precio Publico (IVA incluido)', 'Precio subdistribuidor (IVA Incluido)',
                'Inicio de Vigencia', 'Fin de Vigencia'
            ],
            'sub distribuidor': [
                'Marca', 'Equipo', 'Codigo SAP', 'Color',
                'Precio Publico (IVA incluido)'
            ]
        };

        const DEFAULT_CSV_URL = 'https://raw.githubusercontent.com/Digshop25/mi-app-precios/main/Lista%2028a%20MOD%202.csv';

        // --- COMPONENTS ---

        // LoginScreen Component
        function LoginScreen({
            username, setUsername, password, setPassword, handleLogin, error,
            isFirebaseInitializing, firestoreError, adminUserExists, creatingAdminUser,
            adminCreationMessage, createInitialAdminUser, firebaseReady, userId
        }) {
            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-100 to-white p-4 font-inter">
                    <div className="card-modern w-full max-w-md">
                        <h2 className="text-3xl font-bold text-center text-gray-800 mb-4">LISTA DE PRECIOS DS</h2>
                        <p className="text-center text-gray-600 text-md mb-8">Bienvenido, favor de ingresar su usuario y contraseÃ±a para ver la lista de precios</p>

                        {isFirebaseInitializing && !firestoreError && (
                            <div className="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded-md mb-4 shadow-sm flex items-center justify-center gap-3" role="alert">
                                <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-yellow-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <span className="block sm:inline">Conectando a Firebase...</span>
                            </div>
                        )}

                        {firestoreError && (
                            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mb-4 shadow-sm" role="alert">
                                <strong className="font-bold">Error de conexiÃ³n:</strong>
                                <span className="block sm:inline"> {firestoreError}</span>
                            </div>
                        )}

                        {error && (
                            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mb-4 shadow-sm" role="alert">
                                <strong className="font-bold">Error:</strong>
                                <span className="block sm:inline"> {error}</span>
                            </div>
                        )}

                        {!isFirebaseInitializing && !firestoreError && (
                            <>
                                <form onSubmit={handleLogin}>
                                    <div className="mb-6">
                                        <label htmlFor="username" className="block text-gray-700 text-sm font-semibold mb-2">
                                        Usuario
                                        </label>
                                        <input
                                        type="text"
                                        id="username"
                                        className="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                                        value={username}
                                        onChange={(e) => setUsername(e.target.value)}
                                        required
                                        aria-label="Usuario"
                                        />
                                    </div>
                                    <div className="mb-6">
                                        <label htmlFor="password" className="block text-gray-700 text-sm font-semibold mb-2">
                                        ContraseÃ±a
                                        </label>
                                        <input
                                        type="password"
                                        id="password"
                                        className="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        required
                                        aria-label="ContraseÃ±a"
                                        />
                                    </div>
                                    <button
                                        type="submit"
                                        className="btn-modern w-full"
                                        disabled={isFirebaseInitializing}
                                    >
                                        {isFirebaseInitializing ? 'Iniciando sesiÃ³n...' : 'Entrar'}
                                    </button>
                                </form>

                                {!adminUserExists && !creatingAdminUser && firebaseReady && userId && (
                                    <div className="mt-6 text-center">
                                        {adminCreationMessage && (
                                            <div className={`px-4 py-2 rounded-md mb-3 text-sm ${adminCreationMessage.includes('Ã©xito') ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} border ${adminCreationMessage.includes('Ã©xito') ? 'border-green-400' : 'border-red-400'}`}>
                                                {adminCreationMessage}
                                            </div>
                                        )}
                                        <button
                                            onClick={createInitialAdminUser}
                                            className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                                            disabled={creatingAdminUser || isFirebaseInitializing}
                                        >
                                            {creatingAdminUser ? 'Creando Admin...' : 'Crear Usuario Admin Inicial (Solo una vez)'}
                                        </button>
                                        <p className="text-gray-500 text-xs mt-2">
                                            Si no puedes iniciar sesiÃ³n, haz clic aquÃ­ para crear el usuario 'admin' con contraseÃ±a 'password123'.
                                        </p>
                                    </div>
                                )}
                                {creatingAdminUser && (
                                    <div className="mt-6 text-center text-blue-700 flex items-center justify-center gap-2">
                                        <svg className="animate-spin h-5 w-5 text-blue-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span>Creando usuario admin...</span>
                                    </div>
                                )}
                            </>
                        )}
                    </div>
                </div>
            );
        }

        // UserManagement Component (for Admin only)
        function UserManagement({
            firebaseReady, firestoreLoading, firestoreError, userId,
            newUsername, setNewUsername, newUserEmail, setNewUserEmail,
            newUserPassword, setNewUserPassword, newUserType, setNewUserType,
            handleCreateUser, successMessage, registeredUsers, error
        }) {
            return (
                <div className="p-4 sm:p-6 lg:p-8 bg-gray-50 border-b border-gray-200">
                    <h3 className="text-2xl font-bold text-gray-800 mb-6 border-b pb-3">GestiÃ³n de Usuarios (Firestore)</h3>
                    {!firebaseReady && (
                        <div className="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded-md mb-4 shadow-sm flex items-center justify-center gap-3" role="alert">
                            <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-yellow-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span className="block sm:inline">Inicializando Firebase...</span>
                        </div>
                    )}
                    {firebaseReady && firestoreLoading && (
                        <div className="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded-md mb-4 shadow-sm flex items-center justify-center gap-3" role="alert">
                            <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span className="block sm:inline">Cargando usuarios de la base de datos...</span>
                        </div>
                    )}
                    {firestoreError && (
                        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mb-4 shadow-sm" role="alert">
                            <strong className="font-bold">Error de la base de datos:</strong>
                            <span className="block sm:inline"> {firestoreError}</span>
                        </div>
                    )}
                    {successMessage && (
                        <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-md mb-4 shadow-sm" role="alert">
                            <span className="block sm:inline"> {successMessage}</span>
                        </div>
                    )}
                    <p className="text-sm text-gray-600 mb-6 p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <strong className="text-blue-700">Nota:</strong> Los usuarios creados aquÃ­ se guardarÃ¡n permanentemente en Firestore.
                        <br/>
                        Tu ID de sesiÃ³n (para referencia de la base de datos): <code className="font-mono text-xs bg-gray-200 p-1 rounded">{userId || 'Cargando...'}</code>
                    </p>
                    {firebaseReady && (
                        <>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                            <div>
                                <label htmlFor="new-username" className="block text-gray-700 text-sm font-semibold mb-2">
                                Nombre de Usuario
                                </label>
                                <input
                                type="text"
                                id="new-username"
                                className="border border-gray-300 rounded-lg px-4 py-2 shadow-sm focus:ring-2 focus:ring-blue-500"
                                value={newUsername}
                                onChange={(e) => setNewUsername(e.target.value)}
                                placeholder="Ej: juan.perez"
                                aria-label="Nombre de Usuario"
                                />
                            </div>
                            <div>
                                <label htmlFor="new-user-email" className="block text-gray-700 text-sm font-semibold mb-2">
                                Email (solo para visualizaciÃ³n)
                                </label>
                                <input
                                type="email"
                                id="new-user-email"
                                className="border border-gray-300 rounded-lg px-4 py-2 shadow-sm focus:ring-2 focus:ring-blue-500"
                                value={newUserEmail}
                                onChange={(e) => setNewUserEmail(e.target.value)}
                                placeholder="Ej: juan.perez@dominio.com"
                                aria-label="Email del nuevo usuario"
                                />
                            </div>
                            <div>
                                <label htmlFor="new-user-password" className="block text-gray-700 text-sm font-semibold mb-2">
                                ContraseÃ±a
                                </label>
                                <input
                                type="password"
                                id="new-user-password"
                                className="border border-gray-300 rounded-lg px-4 py-2 shadow-sm focus:ring-2 focus:ring-blue-500"
                                value={newUserPassword}
                                onChange={(e) => setNewUserPassword(e.target.value)}
                                placeholder="ContraseÃ±a segura"
                                aria-label="ContraseÃ±a del nuevo usuario"
                                />
                            </div>
                            <div>
                                <label htmlFor="new-user-type" className="block text-gray-700 text-sm font-semibold mb-2">
                                Tipo de Usuario
                                </label>
                                <select
                                id="new-user-type"
                                className="border border-gray-300 rounded-lg px-4 py-2 shadow-sm focus:ring-2 focus:ring-blue-500"
                                value={newUserType}
                                onChange={(e) => setNewUserType(e.target.value)}
                                aria-label="Tipo de usuario para el nuevo usuario"
                                >
                                <option value="sub distribuidor">Sub Distribuidor</option>
                                <option value="distribuidor">Distribuidor</option>
                                <option value="direccion">DirecciÃ³n</option>
                                <option value="admin">Administrador</option>
                                </select>
                            </div>
                            <div className="flex items-end col-span-1 md:col-span-2 lg:col-span-1">
                                <button
                                onClick={handleCreateUser}
                                className="btn-modern w-full"
                                disabled={firestoreLoading}
                                >
                                {firestoreLoading ? 'Creando...' : 'Crear Usuario'}
                                </button>
                            </div>
                            </div>
                            {error && <p className="text-red-500 text-sm text-center mb-4">{error}</p>}

                            <h4 className="text-xl font-bold text-gray-700 mb-4 border-b pb-2">Usuarios Registrados (Desde Firestore)</h4>
                            <div className="overflow-x-auto rounded-lg border border-gray-200 shadow-custom-light">
                            {firestoreLoading && registeredUsers.length === 0 ? (
                                <p className="text-center text-gray-600 py-4">Cargando usuarios de la base de datos...</p>
                            ) : (
                                <table className="min-w-full bg-white excel-table">
                                <thead>
                                    <tr>
                                    <th className="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider border-b border-gray-200">
                                        Usuario
                                    </th>
                                    <th className="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider border-b border-gray-200">
                                        Email
                                    </th>
                                    <th className="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider border-b border-gray-200">
                                        Tipo
                                    </th>
                                    <th className="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider border-b border-gray-200">
                                        ID (Firestore)
                                    </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {registeredUsers.map((user, index) => (
                                    <tr key={user.id} className={`${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-gray-100 transition duration-150`}>
                                        <td className="py-3 px-4 text-gray-800 border-b border-gray-100 table-cell-responsive">{user.username}</td>
                                        <td className="py-3 px-4 text-gray-700 border-b border-gray-100 table-cell-responsive">{user.email || 'N/A'}</td>
                                        <td className="py-3 px-4 text-gray-700 border-b border-gray-100 capitalize table-cell-responsive">{user.type}</td>
                                        <td className="py-3 px-4 text-gray-500 text-xs border-b border-gray-100 table-cell-responsive">{user.id}</td>
                                    </tr>
                                    ))}
                                    {registeredUsers.length === 0 && (
                                    <tr>
                                        <td colSpan="4" className="py-4 text-center text-gray-500">No hay usuarios registrados en la base de datos.</td>
                                    </tr>
                                    )}
                                </tbody>
                                </table>
                            )}
                            </div>
                        </>
                    )}
                </div>
            );
        }

        // FiltersAndActions Component
        function FiltersAndActions({
            selectedBrand, setSelectedBrand, searchTerm, setSearchTerm, uniqueBrands,
            handlePrintSelected, selectedItems
        }) {
            return (
                <div className="p-4 sm:p-6 lg:p-8 bg-gray-50 border-b border-gray-200 flex flex-col sm:flex-row items-center justify-start gap-4">
                    <div className="w-full sm:w-auto flex-grow">
                        <label htmlFor="brand-select" className="block text-gray-700 text-sm font-semibold mb-2">
                            Filtrar por Marca:
                        </label>
                        <select
                            id="brand-select"
                            className="border border-gray-300 rounded-lg px-4 py-2 shadow-sm focus:ring-2 focus:ring-blue-500 w-full bg-white"
                            value={selectedBrand}
                            onChange={(e) => setSelectedBrand(e.target.value)}
                            aria-label="Seleccionar Marca"
                        >
                            <option value="">Todas las Marcas</option>
                            {uniqueBrands.map(brand => (
                                <option key={brand} value={brand}>{brand}</option>
                            ))}
                        </select>
                    </div>
                    <div className="w-full sm:w-auto flex-grow">
                        <label htmlFor="model-search" className="block text-gray-700 text-sm font-semibold mb-2">
                            Buscar por Modelo o CÃ³digo SAP:
                        </label>
                        <input
                            type="text"
                            id="model-search"
                            className="border border-gray-300 rounded-lg px-4 py-2 w-full shadow-sm focus:ring-2 focus:ring-blue-500"
                            placeholder="Ej: Nitro 5, ACN5-001"
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            aria-label="Buscar por Modelo de Equipo o CÃ³digo SAP"
                        />
                    </div>
                    <div className="w-full sm:w-auto flex-shrink-0 mt-4 sm:mt-0">
                        <button
                            onClick={handlePrintSelected}
                            className="btn-modern w-full bg-green-600 hover:bg-green-700 focus:ring-green-500 no-print"
                            disabled={selectedItems.size === 0}
                        >
                            Imprimir SelecciÃ³n ({selectedItems.size})
                        </button>
                    </div>
                </div>
            );
        }

        // PriceTable Component
        function PriceTable({
            filteredPriceData, columnsToDisplay, selectedItems, handleCheckboxChange, userType
        }) {
            return (
                <div className="p-4 sm:p-6 lg:p-8 overflow-x-auto">
                    {userType && (
                        <div className="mb-4 text-sm text-gray-700 p-3 bg-blue-50 rounded-lg border border-blue-200 shadow-sm">
                            <p>Datos de precios cargados: <span className="font-semibold">{filteredPriceData.length}</span> elementos</p>
                            <p>Columnas a mostrar para <span className="font-bold capitalize text-blue-700">{userType}</span>: <span className="font-semibold">{columnsToDisplay.length}</span> columnas</p>
                        </div>
                    )}

                    {filteredPriceData.length > 0 ? (
                        <table className="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden shadow-custom-light excel-table">
                            <thead>
                                <tr>
                                    <th className="py-3 px-4 text-xs sm:text-sm font-semibold text-gray-700 uppercase tracking-wider border-b border-gray-200 bg-gray-100">
                                        Seleccionar
                                    </th>
                                    {columnsToDisplay.length > 0 ? (
                                        columnsToDisplay.map(col => (
                                            <th key={col.key} className={`py-3 px-4 text-xs sm:text-sm font-semibold text-gray-700 uppercase tracking-wider border-b border-gray-200 bg-gray-100 ${col.align === 'right' ? 'text-right' : 'text-left'}`}>
                                                {col.label}
                                            </th>
                                        ))
                                    ) : (
                                        <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider border-b border-gray-200" colSpan={allColumns.length}>
                                            No hay columnas para mostrar para este tipo de usuario.
                                        </th>
                                    )}
                                </tr>
                            </thead>
                            <tbody>
                                {filteredPriceData.map((item, index) => (
                                    <tr key={item.id} className={`${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-gray-100 transition duration-150 ease-in-out`}>
                                        <td className="py-3 px-4 text-gray-800 border-b border-gray-100 text-sm table-cell-responsive text-center">
                                            <input
                                                type="checkbox"
                                                checked={selectedItems.has(item.id)}
                                                onChange={(e) => handleCheckboxChange(item.id, e.target.checked)}
                                                className="form-checkbox h-4 w-4 text-blue-600 rounded focus:ring-blue-500"
                                                aria-label={`Seleccionar ${item.Equipo}`}
                                            />
                                        </td>
                                        {columnsToDisplay.length > 0 ? (
                                            columnsToDisplay.map(col => (
                                                <td key={`${item.id}-${col.key}`} className={`py-3 px-4 text-gray-800 border-b border-gray-100 text-sm table-cell-responsive ${col.align === 'right' ? 'text-right' : 'text-left'}`}>
                                                    {col.key.startsWith('Precio') || col.key === 'Utilidad DS'
                                                        ? `$${item[col.key] ? parseFloat(item[col.key]).toFixed(2) : '0.00'}`
                                                        : item[col.key]}
                                                </td>
                                            ))
                                        ) : (
                                            <td colSpan={allColumns.length} className="py-4 text-center text-gray-500 text-sm">
                                                No hay datos de columna para mostrar para este tipo de usuario.
                                            </td>
                                        )}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    ) : (
                        <p className="text-center text-gray-600 py-8 text-lg bg-gray-50 rounded-lg border border-gray-200 p-4 shadow-sm">No se encontraron resultados para los filtros aplicados. Por favor, ajusta tu bÃºsqueda.</p>
                    )}
                </div>
            );
        }

        // Dashboard Component (main logged-in view)
        function Dashboard({
            userType, handleLogout, priceData, csvLoading, error,
            selectedBrand, setSelectedBrand, searchTerm, setSearchTerm, uniqueBrands,
            handlePrintSelected, selectedItems,
            registeredUsers, firestoreLoading, firestoreError, userId,
            newUsername, setNewUsername, newUserEmail, setNewUserEmail,
            newUserPassword, setNewUserPassword, newUserType, setNewUserType,
            handleCreateUser, successMessage
        }) {
            const columnsToDisplay = userType ? allColumns.filter(col => columnVisibility[userType] && columnVisibility[userType].includes(col.key)) : [];

            // Memoized filtered price data based on selected brand and search term
            const filteredPriceData = React.useMemo(() => {
                return priceData.filter(item => {
                    const matchesBrand = selectedBrand === '' || item.Marca === selectedBrand;
                    const lowerCaseSearchTerm = searchTerm.toLowerCase();
                    const matchesSearchTerm = searchTerm === '' ||
                                                (item.Equipo && item.Equipo.toLowerCase().includes(lowerCaseSearchTerm)) ||
                                                (item['Codigo SAP'] && item['Codigo SAP'].toLowerCase().includes(lowerCaseSearchTerm));
                    return matchesBrand && matchesSearchTerm;
                });
            }, [priceData, selectedBrand, searchTerm]);

            return (
                <div className="min-h-screen bg-gray-100 p-4 sm:p-6 lg:p-8 font-inter">
                    <div className="max-w-7xl mx-auto bg-white rounded-xl shadow-custom-strong overflow-hidden border border-gray-200">
                        <header className="bg-gradient-to-r from-blue-600 to-purple-700 p-6 flex justify-between items-center text-white shadow-custom-medium">
                            <div className="flex-grow text-center">
                                <h1 className="text-3xl sm:text-4xl font-extrabold text-shadow-lg inline-block mx-auto">Lista de Precios</h1>
                            </div>
                            <div className="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4">
                                <span className="text-lg sm:text-xl font-light">Bienvenido, <span className="font-bold capitalize">{userType}</span>!</span>
                                <button
                                    onClick={handleLogout}
                                    className="bg-white text-blue-600 hover:bg-blue-100 font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2"
                                >
                                    Cerrar SesiÃ³n
                                </button>
                            </div>
                        </header>

                        {userType === 'admin' && (
                            <UserManagement
                                firebaseReady={firebaseReady}
                                firestoreLoading={firestoreLoading}
                                firestoreError={firestoreError}
                                userId={userId}
                                newUsername={newUsername}
                                setNewUsername={setNewUsername}
                                newUserEmail={newUserEmail}
                                setNewUserEmail={setNewUserEmail}
                                newUserPassword={newUserPassword}
                                setNewUserPassword={setNewUserPassword}
                                newUserType={newUserType}
                                setNewUserType={setNewUserType}
                                handleCreateUser={handleCreateUser}
                                successMessage={successMessage}
                                registeredUsers={registeredUsers}
                                error={error} // Pass general error for user management form
                            />
                        )}

                        {csvLoading && (
                            <div className="p-4 sm:p-6 lg:p-8 bg-blue-50 border-b border-blue-200 flex items-center justify-center gap-4 rounded-b-xl">
                                <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <p className="text-blue-700 font-semibold">Cargando datos de precios...</p>
                            </div>
                        )}
                        {error && (
                            <div className="p-4 sm:p-6 lg:p-8 bg-red-100 border-b border-red-400 text-red-700 flex items-center justify-center gap-4 rounded-b-xl">
                                <strong className="font-bold">Error al cargar CSV:</strong>
                                <span className="block sm:inline"> {error}</span>
                            </div>
                        )}

                        <FiltersAndActions
                            selectedBrand={selectedBrand}
                            setSelectedBrand={setSelectedBrand}
                            searchTerm={searchTerm}
                            setSearchTerm={setSearchTerm}
                            uniqueBrands={uniqueBrands}
                            handlePrintSelected={handlePrintSelected}
                            selectedItems={selectedItems}
                        />

                        <PriceTable
                            filteredPriceData={filteredPriceData}
                            columnsToDisplay={columnsToDisplay}
                            selectedItems={selectedItems}
                            handleCheckboxChange={handleCheckboxChange}
                            userType={userType}
                        />
                    </div>
                </div>
            );
        }


        // Main App Component
        function App() {
          const [userType, setUserType] = React.useState(null);
          const [username, setUsername] = React.useState('');
          const [password, setPassword] = React.useState('');
          const [error, setError] = React.useState(null); // General error for login/CSV
          const [priceData, setPriceData] = React.useState(initialMockPriceData);
          const [csvLoading, setCsvLoading] = React.useState(false); // State for CSV loading indicator

          // Firestore related states
          const [registeredUsers, setRegisteredUsers] = React.useState([]); // Users fetched from Firestore
          const [firestoreLoading, setFirestoreLoading] = React.useState(true); // Initial loading for Firestore users
          const [firestoreError, setFirestoreError] = React.useState(null);
          const [userId, setUserId] = React.useState(null); // Firebase Auth UID
          const [firebaseReady, setFirebaseReady] = React.useState(false); // New state for Firebase readiness
          const [isFirebaseInitializing, setIsFirebaseInitializing] = React.useState(window.isFirebaseInitializingGlobally);

          // New states for initial admin user creation
          const [adminUserExists, setAdminUserExists] = React.useState(false);
          const [creatingAdminUser, setCreatingAdminUser] = React.useState(false);
          const [adminCreationMessage, setAdminCreationMessage] = React.useState(null);

          // New states for new user creation form
          const [newUsername, setNewUsername] = React.useState('');
          const [newUserEmail, setNewUserEmail] = React.useState('');
          const [newUserPassword, setNewUserPassword] = React.useState('');
          const [newUserType, setNewUserType] = React.useState('sub distribuidor');
          const [successMessage, setSuccessMessage] = React.useState(null); // New state for success messages

          // New states for search/filter
          const [selectedBrand, setSelectedBrand] = React.useState(''); // '' means all brands
          const [searchTerm, setSearchTerm] = React.useState('');

          // New state for selected items for printing
          const [selectedItems, setSelectedItems] = React.useState(new Set()); // Stores IDs of selected items

          // Effect for Firebase readiness and global error handling
          React.useEffect(() => {
            const updateFirebaseStates = () => {
                if (window.globalFirebaseError) {
                    setFirestoreError(window.globalFirebaseError);
                    setIsFirebaseInitializing(false);
                    setFirestoreLoading(false);
                    return;
                }

                if (window.firebaseInitialized) {
                    setFirebaseReady(true);
                    setIsFirebaseInitializing(false);
                    if (!window.auth._is || !window.auth.currentUser) {
                        const unsubscribeAuth = window.auth.onAuthStateChanged(user => {
                            if (user) {
                                setUserId(user.uid);
                                console.log("Firebase Auth UID:", user.uid);
                            } else {
                                setUserId(null);
                                console.log("No Firebase user logged in (anonymous or custom token needed).");
                            }
                        });
                        return unsubscribeAuth;
                    }
                } else if (window.isFirebaseInitializingGlobally) {
                    setIsFirebaseInitializing(true);
                    const timeoutId = setTimeout(updateFirebaseStates, 100);
                    return () => clearTimeout(timeoutId);
                } else {
                    console.warn("Firebase not initialized and not globally initializing. Assuming silent failure.");
                    setIsFirebaseInitializing(false);
                    setFirestoreLoading(false);
                    setFirestoreError("No se pudo conectar a Firebase. Por favor, revisa tu configuraciÃ³n y la consola del navegador.");
                }
                return null;
            };

            const unsubscribe = updateFirebaseStates();

            return () => {
                if (unsubscribe) unsubscribe();
            };
          }, []);

          // Effect for fetching users from Firestore in real-time and checking for admin
          React.useEffect(() => {
            if (firebaseReady && userId && window.db && window.appId) {
                setFirestoreLoading(true);
                setFirestoreError(null);
                try {
                    const usersCollectionRef = window.collection(window.db, `artifacts/${window.appId}/public/data/users`);
                    const q = window.query(usersCollectionRef);

                    const unsubscribeFirestore = window.onSnapshot(q, (snapshot) => {
                        const users = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setRegisteredUsers(users);
                        const adminFound = users.some(u => u.username === 'admin' && u.type === 'admin');
                        setAdminUserExists(adminFound);
                        setFirestoreLoading(false);
                        console.log("Usuarios cargados de Firestore:", users);
                        console.log("Admin user exists:", adminFound);
                    }, (err) => {
                        console.error("Error fetching users from Firestore (onSnapshot callback):", err);
                        setFirestoreError(`Error al cargar usuarios de la base de datos: ${err.message}`);
                        setFirestoreLoading(false);
                    });

                    return () => unsubscribeFirestore();
                } catch (e) {
                    console.error("Error setting up Firestore listener (useEffect catch):", e);
                    setFirestoreError(`Error al configurar la escucha de Firestore: ${e.message}`);
                    setFirestoreLoading(false);
                }
            } else if (!firebaseReady || !userId) {
                setRegisteredUsers([]);
                setFirestoreLoading(false);
                setAdminUserExists(false);
            }
          }, [firebaseReady, userId, window.db, window.appId]);


          // Handle login attempt (NOW uses Firestore for authentication)
          const handleLogin = async (e) => {
            e.preventDefault();
            setError(null);
            setFirestoreLoading(true);

            if (!firebaseReady || !window.db) {
                setError('Firebase no estÃ¡ listo. Por favor, espera un momento e intenta de nuevo.');
                setFirestoreLoading(false);
                return;
            }

            try {
                const usersCollectionRef = window.collection(window.db, `artifacts/${window.appId}/public/data/users`);
                const q = window.query(
                    usersCollectionRef,
                    window.where('username', '==', username),
                    window.where('password', '==', password)
                );
                const querySnapshot = await window.getDocs(q);

                if (!querySnapshot.empty) {
                    const foundUserDoc = querySnapshot.docs[0].data();
                    setUserType(foundUserDoc.type);
                    setError(null);
                    console.log(`Usuario ${foundUserDoc.username} (${foundUserDoc.type}) ha iniciado sesiÃ³n desde Firestore.`);
                    setCsvLoading(true); // Start CSV loading
                    await loadCsvFromUrl(DEFAULT_CSV_URL, setPriceData, setError, initialMockPriceData, Papa); // Pass Papa
                    setCsvLoading(false); // End CSV loading
                } else {
                    setError("Nombre de usuario o contraseÃ±a incorrectos.");
                }
            } catch (e) {
                console.error("Error during login from Firestore:", e);
                setError(`Error al iniciar sesiÃ³n: ${e.message}. Por favor, revisa la consola.`);
            } finally {
                setFirestoreLoading(false);
            }
          };

          // Function to create the initial admin user in Firestore
          const createInitialAdminUser = async () => {
            if (!firebaseReady || !window.db || !userId) {
                setAdminCreationMessage('Firebase no estÃ¡ listo o no hay un usuario autenticado para crear el admin.');
                return;
            }
            setCreatingAdminUser(true);
            setAdminCreationMessage(null);
            setError(null);

            try {
                const usersCollectionRef = window.collection(window.db, `artifacts/${window.appId}/public/data/users`);
                const q = window.query(usersCollectionRef, window.where('username', '==', 'admin'), window.where('type', '==', 'admin'));
                const querySnapshot = await window.getDocs(q);

                if (!querySnapshot.empty) {
                    setAdminCreationMessage('El usuario admin ya existe en Firestore.');
                    setAdminUserExists(true);
                    return;
                }

                await window.addDoc(usersCollectionRef, {
                    username: 'admin',
                    password: 'password123',
                    type: 'admin',
                    createdAt: new Date(),
                    createdBy: userId
                });
                setAdminUserExists(true);
                setAdminCreationMessage('Usuario admin creado con Ã©xito en Firestore. Ahora puedes iniciar sesiÃ³n.');
                setUsername('admin');
                setPassword('password123');
            } catch (e) {
                console.error("Error creating initial admin user:", e);
                setAdminCreationMessage(`Error al crear el usuario admin: ${e.message}. Revisa las reglas de seguridad de Firestore.`);
            } finally {
                setCreatingAdminUser(false);
            }
          };

          // Handle logout
          const handleLogout = () => {
            setUserType(null);
            setUsername('');
            setPassword('');
            setError(null);
            setPriceData(initialMockPriceData);
            setNewUsername('');
            setNewUserEmail('');
            setNewUserPassword('');
            setNewUserType('sub distribuidor');
            setSelectedBrand('');
            setSearchTerm('');
            setSelectedItems(new Set());
            console.log("SesiÃ³n cerrada.");
          };

          const handleCreateUser = async () => {
            if (!newUsername || !newUserEmail || !newUserPassword) {
              setError('Todos los campos (usuario, email, contraseÃ±a) son obligatorios.');
              return;
            }
            if (registeredUsers.some(u => u.username === newUsername)) {
              setError('Este nombre de usuario ya existe. Por favor, elige otro.');
              return;
            }

            if (!window.db || !userId) {
                setFirestoreError('La base de datos no estÃ¡ lista o no hay un usuario autenticado. Por favor, intenta de nuevo en unos segundos.');
                return;
            }

            setFirestoreLoading(true);
            setFirestoreError(null);
            setSuccessMessage(null);

            try {
                const usersCollectionRef = window.collection(window.db, `artifacts/${window.appId}/public/data/users`);
                await window.addDoc(usersCollectionRef, {
                    username: newUsername,
                    email: newUserEmail,
                    password: newUserPassword,
                    type: newUserType,
                    createdAt: new Date(),
                    createdBy: userId
                });

                setNewUsername('');
                setNewUserEmail('');
                setNewUserPassword('');
                setNewUserType('sub distribuidor');
                setError(null);
                setSuccessMessage("Usuario creado en la base de datos con Ã©xito.");
                setTimeout(() => setSuccessMessage(null), 5000);
            } catch (e) {
                console.error("Error creating user in Firestore:", e);
                setFirestoreError(`Error al crear el usuario en la base de datos: ${e.message}`);
            } finally {
                setFirestoreLoading(false);
            }
          };

          // Handle checkbox change for item selection
          const handleCheckboxChange = (itemId, isChecked) => {
            setSelectedItems(prevSelectedItems => {
              const newSet = new Set(prevSelectedItems);
              if (isChecked) {
                newSet.add(itemId);
              } else {
                newSet.delete(itemId);
              }
              return newSet;
            });
          };

          // Handle printing selected items
          const handlePrintSelected = () => {
            if (selectedItems.size === 0) {
              alert('Por favor, selecciona al menos un modelo para imprimir.');
              return;
            }

            const itemsToPrint = priceData.filter(item => selectedItems.has(item.id));
            const columnsForPrint = allColumns.filter(col => columnVisibility[userType] && columnVisibility[userType].includes(col.key));

            let printContent = `
                <div style="font-family: 'Inter', sans-serif; padding: 20px;">
                    <h1 style="text-align: center; font-size: 24px; margin-bottom: 20px; color: #333;">Lista de Modelos Seleccionados</h1>
                    <table class="excel-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                ${columnsForPrint.map(col => `
                                    <th style="border: 1px solid #ccc; padding: 8px; text-align: ${col.align}; background-color: #f2f2f2; font-weight: bold; font-size: 10px;">
                                        ${col.label}
                                    </th>
                                `).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsToPrint.map((item, index) => `
                                <tr style="background-color: ${index % 2 === 0 ? '#fff' : '#f9f9f9'};">
                                    ${columnsForPrint.map(col => `
                                        <td style="border: 1px solid #ccc; padding: 8px; font-size: 10px; text-align: ${col.align};">
                                            ${col.key.startsWith('Precio') || col.key === 'Utilidad DS'
                                                ? `$${item[col.key] ? parseFloat(item[col.key]).toFixed(2) : '0.00'}`
                                                : item[col.key]}
                                        </td>
                                    `).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Imprimir Lista</title>');
            printWindow.document.write(`
                <style>
                    body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
                    .excel-table { border-collapse: collapse; width: 100%; }
                    .excel-table th, .excel-table td { border: 1px solid #ccc; padding: 8px; font-size: 10px; text-align: left; white-space: normal; }
                    .excel-table th { background-color: #f2f2f2; font-weight: bold; color: #333; text-align: center; }
                    .excel-table tbody tr:nth-child(even) { background-color: #f9f9f9; }
                    .excel-table td.text-right { text-align: right; }
                    h1 { text-align: center; font-size: 24px; margin-bottom: 20px; color: #333; }
                </style>
            `);
            printWindow.document.write('</head><body>');
            printWindow.document.write(printContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
          };

          // Memoized list of unique brands for the dropdown
          const uniqueBrands = React.useMemo(() => {
            const brands = new Set();
            priceData.forEach(item => {
              if (item.Marca) {
                brands.add(item.Marca);
              }
            });
            return ['', ...Array.from(brands).sort()];
          }, [priceData]);

          if (!userType) {
            return (
              <LoginScreen
                username={username}
                setUsername={setUsername}
                password={password}
                setPassword={setPassword}
                handleLogin={handleLogin}
                error={error}
                isFirebaseInitializing={isFirebaseInitializing}
                firestoreError={firestoreError}
                adminUserExists={adminUserExists}
                creatingAdminUser={creatingAdminUser}
                adminCreationMessage={adminCreationMessage}
                createInitialAdminUser={createInitialAdminUser}
                firebaseReady={firebaseReady}
                userId={userId}
              />
            );
          }

          return (
            <Dashboard
                userType={userType}
                handleLogout={handleLogout}
                priceData={priceData}
                csvLoading={csvLoading}
                error={error}
                selectedBrand={selectedBrand}
                setSelectedBrand={setSelectedBrand}
                searchTerm={searchTerm}
                setSearchTerm={setSearchTerm}
                uniqueBrands={uniqueBrands}
                handlePrintSelected={handlePrintSelected}
                selectedItems={selectedItems}
                registeredUsers={registeredUsers}
                firestoreLoading={firestoreLoading}
                firestoreError={firestoreError}
                userId={userId}
                newUsername={newUsername}
                setNewUsername={setNewUsername}
                newUserEmail={newUserEmail}
                setNewUserEmail={setNewUserEmail}
                newUserPassword={newUserPassword}
                setNewUserPassword={setNewUserPassword}
                newUserType={newUserType}
                setNewUserType={setNewUserType}
                handleCreateUser={handleCreateUser}
                successMessage={successMessage}
            />
          );
        }

        // Mount the React application to the 'root' div AFTER the window has loaded
        window.onload = function() {
            try {
                ReactDOM.createRoot(document.getElementById('root')).render(<App />);
            } catch (e) {
                console.error("Error during initial React render:", e);
                const rootDiv = document.getElementById('root');
                if (rootDiv) {
                    rootDiv.innerHTML = '<div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background-color: #fef2f2; color: #ef4444; font-family: \'Inter\', sans-serif; padding: 20px; border: 1px solid #f87171; border-radius: 8px; margin: 20px;">' +
                                        '<p style="font-size: 1.25rem; font-weight: 600; text-align: center;">Ha ocurrido un error crÃ­tico al iniciar la aplicaciÃ³n. Por favor, verifica la consola del navegador (<span style="font-family: monospace;">F12</span>) para mÃ¡s detalles.</p>' +
                                        '</div>';
                }
            }
        };
    </script>
</body>
</html>
