<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Precios</title>
    <!-- Tailwind CSS CDN -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/3.4.3/tailwind.min.css" rel="stylesheet">
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            background-color: #f3f4f6; /* Light gray background for the whole page */
        }
        /* Custom shadows for better visual appeal */
        .shadow-custom-light {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .shadow-custom-medium {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .shadow-custom-strong {
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.1), 0 10px 10px rgba(0, 0, 0, 0.04);
        }
        .text-shadow-lg {
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        /* Responsive adjustments for table cells */
        @media (max-width: 640px) {
            .table-cell-responsive {
                font-size: 0.75rem; /* Smaller font on small screens */
                padding: 0.5rem 0.75rem; /* Adjust padding */
            }
        }
        /* Specific styles for Excel-like table appearance */
        .excel-table {
            border-collapse: collapse; /* Ensures single borders */
            width: 100%;
        }
        .excel-table th, .excel-table td {
            border: 1px solid #e2e8f0; /* Light gray border for all cells */
            padding: 0.75rem 1rem; /* Consistent padding */
            text-align: left;
        }
        .excel-table thead th {
            background-color: #e2e8f0; /* Light gray background for headers */
            font-weight: 600; /* Semi-bold headers */
            color: #4a5568; /* Darker text for headers */
            text-transform: uppercase;
            font-size: 0.875rem; /* Slightly larger font for headers */
        }
        .excel-table tbody tr:nth-child(even) {
            background-color: #f8fafc; /* Lighter alternating row color */
        }
        .excel-table tbody tr:hover {
            background-color: #f0f4f8; /* Subtle hover effect */
        }
    </style>

    <!-- React CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel CDN (for JSX transformation in the browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- PapaParse CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Define the initial mock price data. This will be replaced by CSV data.
        const initialMockPriceData = [
          { id: 1, 'Tipo Equipo': 'Laptop', Marca: 'Acer', Equipo: 'Nitro 5', 'Codigo SAP': 'ACN5-001', Color: 'Negro', 'Precio Publico (IVA incluido)': 1500, 'PrecioFacturacion distribuidor (con sim e IVA Incluido)': 1200, 'Precio subdistribuidor (IVA Incluido)': 1000, 'Inicio de Vigencia': '2024-01-01', 'Fin de Vigencia': '2024-12-31', 'Utilidad DS': 0.20 },
          { id: 2, 'Tipo Equipo': 'Monitor', Marca: 'Samsung', Equipo: 'Odyssey G7', 'Codigo SAP': 'SMOG7-002', Color: 'Negro', 'Precio Publico (IVA incluido)': 400, 'PrecioFacturacion distribuidor (con sim e IVA Incluido)': 350, 'Precio subdistribuidor (IVA Incluido)': 300, 'Inicio de Vigencia': '2024-01-01', 'Fin de Vigencia': '2024-12-31', 'Utilidad DS': 0.15 },
          { id: 3, 'Tipo Equipo': 'Teclado', Marca: 'HyperX', Equipo: 'Alloy Origins', 'Codigo SAP': 'HXAO-003', Color: 'Negro', 'Precio Publico (IVA incluido)': 110, 'PrecioFacturacion distribuidor (con sim e IVA Incluido)': 95, 'Precio subdistribuidor (IVA Incluido)': 80, 'Inicio de Vigencia': '2024-01-01', 'Fin de Vigencia': '2024-12-31', 'Utilidad DS': 0.10 },
          { id: 4, 'Tipo Equipo': 'Mouse', Marca: 'Logitech', Equipo: 'G502 Hero', 'Codigo SAP': 'LGG502-004', Color: 'Negro', 'Precio Publico (IVA incluido)': 50, 'PrecioFacturacion distribuidor (con sim e IVA Incluido)': 40, 'Precio subdistribuidor (IVA Incluido)': 30, 'Inicio de Vigencia': '2024-01-01', 'Fin de Vigencia': '2024-12-31', 'Utilidad DS': 0.05 },
          { id: 5, 'Tipo Equipo': 'Auriculares', Marca: 'Razer', Equipo: 'Kraken X', 'Codigo SAP': 'RZKX-005', Color: 'Verde', 'Precio Publico (IVA incluido)': 160, 'PrecioFacturacion distribuidor (con sim e IVA Incluido)': 140, 'Precio subdistribuidor (IVA Incluido)': 120, 'Inicio de Vigencia': '2024-01-01', 'Fin de Vigencia': '2024-12-31', 'Utilidad DS': 0.12 },
        ];

        // Hardcoded user data for authentication (local management)
        const initialMockUsers = [
          { id: 'mock-admin', username: 'admin', password: 'password123', type: 'admin', email: 'admin@example.com' },
          { id: 'mock-direccion', username: 'direccion', password: 'password123', type: 'direccion', email: 'direccion@example.com' },
          { id: 'mock-distribuidor', username: 'distribuidor', password: 'password123', type: 'distribuidor', email: 'distribuidor@example.com' },
          { id: 'mock-subdistribuidor', username: 'subdistribuidor', password: 'password123', type: 'sub distribuidor', email: 'subdistribuidor@example.com' },
        ];

        // Define column headers and their display names
        const allColumns = [
            { key: 'Tipo Equipo', label: 'Tipo Equipo' },
            { key: 'Marca', label: 'Marca' },
            { key: 'Equipo', label: 'Equipo' },
            { key: 'Codigo SAP', label: 'Código SAP' },
            { key: 'Color', label: 'Color' },
            { key: 'Precio Publico (IVA incluido)', label: 'Precio Público (IVA incluido)' },
            { key: 'PrecioFacturacion distribuidor (con sim e IVA Incluido)', label: 'Precio Facturación Distribuidor (con sim e IVA Incluido)' },
            { key: 'Precio subdistribuidor (IVA Incluido)', label: 'Precio Subdistribuidor (IVA Incluido)' },
            { key: 'Inicio de Vigencia', label: 'Inicio de Vigencia' },
            { key: 'Fin de Vigencia', label: 'Fin de Vigencia' },
            { key: 'Utilidad DS', label: 'Utilidad DS' }
        ];

        // Define column visibility rules based on user type
        const columnVisibility = {
            admin: [
                'Tipo Equipo',
                'Marca',
                'Equipo',
                'Codigo SAP',
                'Color',
                'Precio Publico (IVA incluido)',
                'PrecioFacturacion distribuidor (con sim e IVA Incluido)',
                'Precio subdistribuidor (IVA Incluido)',
                'Inicio de Vigencia',
                'Fin de Vigencia',
                'Utilidad DS'
            ],
            direccion: [
                'Marca',
                'Equipo',
                'Codigo SAP',
                'Color',
                'Precio Publico (IVA incluido)',
                'Precio subdistribuidor (IVA Incluido)',
                'Inicio de Vigencia',
                'Fin de Vigencia',
                'Utilidad DS'
            ],
            distribuidor: [
                'Marca',
                'Equipo',
                'Codigo SAP',
                'Color',
                'Precio Publico (IVA incluido)',
                'Precio subdistribuidor (IVA Incluido)', // Added for 'distribuidor'
                'Inicio de Vigencia',
                'Fin de Vigencia'
            ],
            'sub distribuidor': [
                'Marca',
                'Equipo',
                'Codigo SAP',
                'Color',
                'Precio Publico (IVA incluido)'
            ]
        };

        // !!! IMPORTANT: REPLACE THIS URL WITH THE RAW URL OF YOUR CSV FILE ON GITHUB !!!
        // Example: https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO_NAME/main/YOUR_FILE.csv
        const DEFAULT_CSV_URL = 'https://raw.githubusercontent.com/Digshop25/mi-app-precios/main/Lista%2028a%20MOD%202.csv'; // Reemplaza esta URL con la tuya real

        // Main App component
        function App() {
          const [userType, setUserType] = React.useState(null);
          const [username, setUsername] = React.useState('');
          const [password, setPassword] = React.useState('');
          const [error, setError] = React.useState(null);
          const [priceData, setPriceData] = React.useState(initialMockPriceData);
          const [registeredUsers, setRegisteredUsers] = React.useState(initialMockUsers);
          const [newUsername, setNewUsername] = React.useState('');
          const [newUserEmail, setNewUserEmail] = React.useState('');
          const [newUserPassword, setNewUserPassword] = React.useState('');
          const [newUserType, setNewUserType] = React.useState('sub distribuidor');
          const [loadingUsers, setLoadingUsers] = React.useState(false);
          const [csvLoading, setCsvLoading] = React.useState(false); // State for CSV loading indicator

          // New states for search/filter
          const [selectedBrand, setSelectedBrand] = React.useState(''); // '' means all brands
          const [searchTerm, setSearchTerm] = React.useState('');

          React.useEffect(() => {
            setLoadingUsers(false);
            console.log("Usuarios inicializados localmente:", registeredUsers);
          }, []);

          // Function to clean and parse numerical values from CSV
          const cleanAndParseFloat = (value) => {
            console.log(`Original value: "${value}"`);
            if (typeof value !== 'string') {
                const parsed = parseFloat(value) || 0;
                console.log(`Not a string, parsed as: ${parsed}`);
                return parsed;
            }

            // Remove any character that is not a digit, a comma, a dot, or a hyphen
            let cleanedValue = value.replace(/[^\d.,-]/g, '');
            console.log(`After initial clean (remove non-numeric, keep .,-): "${cleanedValue}"`);

            // Determine if comma or dot is the decimal separator
            // If both exist, the last one is typically the decimal
            const hasComma = cleanedValue.includes(',');
            const hasDot = cleanedValue.includes('.');

            if (hasComma && hasDot) {
                // If comma appears after dot, comma is decimal (e.g., "1.234,56")
                if (cleanedValue.indexOf(',') > cleanedValue.indexOf('.')) {
                    cleanedValue = cleanedValue.replace(/\./g, ''); // Remove thousands dots
                    cleanedValue = cleanedValue.replace(/,/g, '.'); // Change decimal comma to dot
                    console.log(`Both, comma is decimal. Cleaned: "${cleanedValue}"`);
                } else {
                    // If dot appears after comma, dot is decimal (e.g., "1,234.56")
                    cleanedValue = cleanedValue.replace(/,/g, ''); // Remove thousands commas
                    // Decimal dot is already correct
                    console.log(`Both, dot is decimal. Cleaned: "${cleanedValue}"`);
                }
            } else if (hasComma) {
                // Only commas, assume it's a decimal comma (e.g., "123,45")
                cleanedValue = cleanedValue.replace(/,/g, '.');
                console.log(`Only comma, treated as decimal. Cleaned: "${cleanedValue}"`);
            }
            // If only dots, assume it's a decimal dot (e.g., "123.45") - no change needed
            // If no dots or commas, it's an integer or invalid - parseFloat will handle

            const parsed = parseFloat(cleanedValue);
            console.log(`Parsed float: ${parsed}`);
            return isNaN(parsed) ? 0 : parsed;
          };

          // Function to load CSV from a given URL
          const loadCsvFromUrl = async (url) => {
            setCsvLoading(true);
            setError(null);
            try {
              const response = await fetch(url);
              if (!response.ok) {
                throw new Error(`Error al cargar el CSV: ${response.statusText} (${response.status}). Asegúrate de que la URL sea correcta y el archivo sea accesible.`);
              }
              const csvText = await response.text();

              Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                  const requiredHeaders = [
                    'Tipo Equipo', 'Marca', 'Equipo', 'Codigo SAP', 'Color',
                    'Precio Publico (IVA incluido)', 'PrecioFacturacion distribuidor (con sim e IVA Incluido)',
                    'Precio subdistribuidor (IVA Incluido)', 'Inicio de Vigencia', 'Fin de Vigencia', 'Utilidad DS'
                  ];
                  const actualHeaders = results.meta.fields;

                  const missingHeaders = requiredHeaders.filter(header => !actualHeaders.includes(header));

                  if (missingHeaders.length > 0) {
                    setError(`Error en el CSV: Faltan las siguientes columnas: ${missingHeaders.join(', ')}. Asegúrate de que los nombres de las columnas coincidan exactamente.`);
                    setPriceData(initialMockPriceData);
                    return;
                  }

                  const parsedData = results.data.map((row, index) => {
                    console.log(`Raw CSV Row ${index + 1}:`, row);
                    const item = {
                        id: index + 1,
                        'Tipo Equipo': row['Tipo Equipo'],
                        Marca: row['Marca'],
                        Equipo: row['Equipo'],
                        'Codigo SAP': row['Codigo SAP'],
                        Color: row['Color'],
                        'Precio Publico (IVA incluido)': cleanAndParseFloat(row['Precio Publico (IVA incluido)']),
                        'PrecioFacturacion distribuidor (con sim e IVA Incluido)': cleanAndParseFloat(row['PrecioFacturacion distribuidor (con sim e IVA Incluido)']),
                        'Precio subdistribuidor (IVA Incluido)': cleanAndParseFloat(row['Precio subdistribuidor (IVA Incluido)']),
                        'Inicio de Vigencia': row['Inicio de Vigencia'],
                        'Fin de Vigencia': row['Fin de Vigencia'],
                        'Utilidad DS': cleanAndParseFloat(row['Utilidad DS']),
                    };
                    console.log(`Parsed Item ${index + 1}:`, item);
                    return item;
                  });

                  if (parsedData.length > 0) {
                    setPriceData(parsedData);
                    setError(null);
                    console.log("CSV cargado y parseado con éxito. Datos:", parsedData);
                  } else {
                    setError('El archivo CSV está vacío o no contiene datos válidos.');
                    setPriceData(initialMockPriceData);
                  }
                },
                error: (err) => {
                  setError(`Error al parsear el archivo CSV: ${err.message}`);
                  setPriceData(initialMockPriceData);
                }
              });
            } catch (err) {
              setError(`Error de red o CORS: ${err.message}. Asegúrate de que la URL sea pública y accesible.`);
              setPriceData(initialMockPriceData);
            } finally {
              setCsvLoading(false);
            }
          };

          // Handle login attempt
          const handleLogin = async (e) => {
            e.preventDefault();
            setError(null);

            const foundUser = registeredUsers.find(u => u.username === username && u.password === password);

            if (foundUser) {
              setUserType(foundUser.type);
              setError(null);
              console.log(`Usuario ${foundUser.username} (${foundUser.type}) ha iniciado sesión.`);
              // Automatically load CSV after successful login
              await loadCsvFromUrl(DEFAULT_CSV_URL);
            } else {
              setError("Nombre de usuario o contraseña incorrectos.");
            }
          };

          // Handle logout
          const handleLogout = () => {
            setUserType(null);
            setUsername('');
            setPassword('');
            setError(null);
            setPriceData(initialMockPriceData); // Reset data on logout
            setNewUsername('');
            setNewUserEmail('');
            setNewUserPassword('');
            setNewUserType('sub distribuidor');
            // Reset filter states on logout
            setSelectedBrand('');
            setSearchTerm('');
            console.log("Sesión cerrada.");
          };

          const handleCreateUser = () => {
            if (!newUsername || !newUserEmail || !newUserPassword) {
              setError('Todos los campos (usuario, email, contraseña) son obligatorios.');
              return;
            }
            if (registeredUsers.some(u => u.username === newUsername)) {
              setError('Este nombre de usuario ya existe. Por favor, elige otro.');
              return;
            }

            const newUser = {
              id: `local-user-${Date.now()}`,
              username: newUsername,
              email: newUserEmail,
              password: newUserPassword,
              type: newUserType,
            };

            setRegisteredUsers(prevUsers => [...prevUsers, newUser]);
            setNewUsername('');
            setNewUserEmail('');
            setNewUserPassword('');
            setNewUserType('sub distribuidor');
            setError(null);
            console.log("Usuario creado localmente (no persistente):", newUser);
            alert("Usuario creado localmente. ¡Atención! Este usuario no se guardará y desaparecerá al recargar la página.");
          };

          // Memoized list of unique brands for the dropdown
          const uniqueBrands = React.useMemo(() => {
            const brands = new Set();
            priceData.forEach(item => {
              if (item.Marca) {
                brands.add(item.Marca);
              }
            });
            return ['', ...Array.from(brands).sort()]; // Add empty string for "All Brands" option
          }, [priceData]);

          // Memoized filtered price data based on selected brand and search term
          const filteredPriceData = React.useMemo(() => {
            return priceData.filter(item => {
              const matchesBrand = selectedBrand === '' || item.Marca === selectedBrand;
              const lowerCaseSearchTerm = searchTerm.toLowerCase();

              // Check if search term matches in 'Equipo' or 'Codigo SAP'
              const matchesSearchTerm = searchTerm === '' ||
                                        (item.Equipo && item.Equipo.toLowerCase().includes(lowerCaseSearchTerm)) ||
                                        (item['Codigo SAP'] && item['Codigo SAP'].toLowerCase().includes(lowerCaseSearchTerm));
              return matchesBrand && matchesSearchTerm;
            });
          }, [priceData, selectedBrand, searchTerm]);


          const columnsToDisplay = userType ? allColumns.filter(col => columnVisibility[userType] && columnVisibility[userType].includes(col.key)) : [];

          if (!userType) {
            return (
              <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-600 p-4 font-inter">
                <div className="bg-white p-8 rounded-xl shadow-custom-strong w-full max-w-md border border-gray-200">
                  <h2 className="text-3xl font-bold text-center text-gray-800 mb-8">Iniciar Sesión</h2>
                  {error && (
                      <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mb-4 shadow-sm" role="alert">
                          <strong className="font-bold">Error:</strong>
                          <span className="block sm:inline"> {error}</span>
                      </div>
                  )}
                  <form onSubmit={handleLogin}>
                    <div className="mb-6">
                      <label htmlFor="username" className="block text-gray-700 text-sm font-semibold mb-2">
                        Usuario
                      </label>
                      <input
                        type="text"
                        id="username"
                        className="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                        value={username}
                        onChange={(e) => setUsername(e.target.value)}
                        required
                        aria-label="Usuario"
                      />
                    </div>
                    <div className="mb-6">
                      <label htmlFor="password" className="block text-gray-700 text-sm font-semibold mb-2">
                        Contraseña
                      </label>
                      <input
                        type="password"
                        id="password"
                        className="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        required
                        aria-label="Contraseña"
                      />
                    </div>
                    <button
                      type="submit"
                      className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                    >
                      Entrar
                    </button>
                  </form>
                  <p className="text-center text-gray-600 text-sm mt-6 leading-relaxed">
                    <span className="font-semibold text-gray-700">Usuarios de prueba (hardcodeados):</span>
                    <br />
                    <span className="font-medium">admin</span> / password123 <span className="text-gray-500">(Administrador)</span>
                    <br />
                    <span className="font-medium">direccion</span> / password123 <span className="text-gray-500">(Dirección)</span>
                    <br />
                    <span className="font-medium">distribuidor</span> / password123 <span className="text-gray-500">(Distribuidor)</span>
                    <br />
                    <span className="font-medium">subdistribuidor</span> / password123 <span className="text-gray-500">(Sub Distribuidor)</span>
                  </p>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gray-100 p-4 sm:p-6 lg:p-8 font-inter">
              <div className="max-w-7xl mx-auto bg-white rounded-xl shadow-custom-strong overflow-hidden border border-gray-200">
                <header className="bg-gradient-to-r from-blue-600 to-purple-700 p-6 flex flex-col sm:flex-row justify-between items-center text-white shadow-custom-medium">
                  <h1 className="text-3xl sm:text-4xl font-extrabold mb-4 sm:mb-0 text-shadow-lg">Lista de Precios</h1>
                  <div className="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4">
                    <span className="text-lg sm:text-xl font-light">Bienvenido, <span className="font-bold capitalize">{userType}</span>!</span>
                    <button
                      onClick={handleLogout}
                      className="bg-white text-blue-600 hover:bg-blue-100 font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2"
                    >
                      Cerrar Sesión
                    </button>
                  </div>
                </header>

                {userType === 'admin' && (
                  <div className="p-4 sm:p-6 lg:p-8 bg-gray-50 border-b border-gray-200">
                    <h3 className="text-2xl font-bold text-gray-800 mb-6 border-b pb-3">Gestión de Usuarios (Local)</h3>
                    <p className="text-sm text-gray-600 mb-6 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                        <strong className="text-red-600">Atención:</strong> Los usuarios creados aquí son solo para demostración y **no se guardarán de forma permanente**. Desaparecerán al recargar la página.
                    </p>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                      <div>
                        <label htmlFor="new-username" className="block text-gray-700 text-sm font-semibold mb-2">
                          Nombre de Usuario
                        </label>
                        <input
                          type="text"
                          id="new-username"
                          className="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                          value={newUsername}
                          onChange={(e) => setNewUsername(e.target.value)}
                          placeholder="Ej: juan.perez"
                          aria-label="Nombre de Usuario"
                        />
                      </div>
                      <div>
                        <label htmlFor="new-user-email" className="block text-gray-700 text-sm font-semibold mb-2">
                          Email (solo para visualización)
                        </label>
                        <input
                          type="email"
                          id="new-user-email"
                          className="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                          value={newUserEmail}
                          onChange={(e) => setNewUserEmail(e.target.value)}
                          placeholder="Ej: juan.perez@dominio.com"
                          aria-label="Email del nuevo usuario"
                        />
                      </div>
                      <div>
                        <label htmlFor="new-user-password" className="block text-gray-700 text-sm font-semibold mb-2">
                          Contraseña
                        </label>
                        <input
                          type="password"
                          id="new-user-password"
                          className="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                          value={newUserPassword}
                          onChange={(e) => setNewUserPassword(e.target.value)}
                          placeholder="Contraseña segura"
                          aria-label="Contraseña del nuevo usuario"
                        />
                      </div>
                      <div>
                        <label htmlFor="new-user-type" className="block text-gray-700 text-sm font-semibold mb-2">
                          Tipo de Usuario
                        </label>
                        <select
                          id="new-user-type"
                          className="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 bg-white"
                          value={newUserType}
                          onChange={(e) => setNewUserType(e.target.value)}
                          aria-label="Tipo de usuario para el nuevo usuario"
                        >
                          <option value="sub distribuidor">Sub Distribuidor</option>
                          <option value="distribuidor">Distribuidor</option>
                          <option value="direccion">Dirección</option>
                          <option value="admin">Administrador</option>
                        </select>
                      </div>
                      <div className="flex items-end col-span-1 md:col-span-2 lg:col-span-1">
                        <button
                          onClick={handleCreateUser}
                          className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                        >
                          Crear Usuario
                        </button>
                      </div>
                    </div>
                    {error && <p className="text-red-500 text-sm text-center mb-4">{error}</p>}

                    <h4 className="text-xl font-bold text-gray-700 mb-4 border-b pb-2">Usuarios Registrados (Local)</h4>
                    <div className="overflow-x-auto rounded-lg border border-gray-200 shadow-custom-light">
                      {loadingUsers ? (
                        <p className="text-center text-gray-600 py-4">Cargando usuarios...</p>
                      ) : (
                        <table className="min-w-full bg-white excel-table">
                          <thead>
                            <tr>
                              <th className="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider border-b border-gray-200">
                                Usuario
                              </th>
                              <th className="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider border-b border-gray-200">
                                Email
                              </th>
                              <th className="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider border-b border-gray-200">
                                Tipo
                              </th>
                              <th className="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider border-b border-gray-200">
                                ID (Local)
                              </th>
                            </tr>
                          </thead>
                          <tbody>
                            {registeredUsers.map((user, index) => (
                              <tr key={user.id} className={`${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-gray-100 transition duration-150`}>
                                <td className="py-3 px-4 whitespace-nowrap text-gray-800 border-b border-gray-100 table-cell-responsive">{user.username}</td>
                                <td className="py-3 px-4 whitespace-nowrap text-gray-700 border-b border-gray-100 table-cell-responsive">{user.email || 'N/A'}</td>
                                <td className="py-3 px-4 whitespace-nowrap text-gray-700 border-b border-gray-100 capitalize table-cell-responsive">{user.type}</td>
                                <td className="py-3 px-4 whitespace-nowrap text-gray-500 text-xs border-b border-gray-100 table-cell-responsive">{user.id}</td>
                              </tr>
                            ))}
                            {registeredUsers.length === 0 && (
                              <tr>
                                <td colSpan="4" className="py-4 text-center text-gray-500">No hay usuarios registrados.</td>
                              </tr>
                            )}
                          </tbody>
                        </table>
                      )}
                    </div>
                  </div>
                )}

                {csvLoading && (
                    <div className="p-4 sm:p-6 lg:p-8 bg-blue-50 border-b border-blue-200 flex items-center justify-center gap-4 rounded-b-xl">
                        <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p className="text-blue-700 font-semibold">Cargando datos de precios...</p>
                    </div>
                )}
                {error && (
                    <div className="p-4 sm:p-6 lg:p-8 bg-red-100 border-b border-red-400 text-red-700 flex items-center justify-center gap-4 rounded-b-xl">
                        <strong className="font-bold">Error al cargar CSV:</strong>
                        <span className="block sm:inline"> {error}</span>
                    </div>
                )}

                {/* Search/Filter Module */}
                <div className="p-4 sm:p-6 lg:p-8 bg-gray-50 border-b border-gray-200 flex flex-col sm:flex-row items-center justify-start gap-4">
                    <div className="w-full sm:w-auto flex-grow">
                        <label htmlFor="brand-select" className="block text-gray-700 text-sm font-semibold mb-2">
                            Filtrar por Marca:
                        </label>
                        <select
                            id="brand-select"
                            className="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 bg-white"
                            value={selectedBrand}
                            onChange={(e) => setSelectedBrand(e.target.value)}
                            aria-label="Seleccionar Marca"
                        >
                            <option value="">Todas las Marcas</option>
                            {uniqueBrands.map(brand => (
                                <option key={brand} value={brand}>{brand}</option>
                            ))}
                        </select>
                    </div>
                    <div className="w-full sm:w-auto flex-grow">
                        <label htmlFor="model-search" className="block text-gray-700 text-sm font-semibold mb-2">
                            Buscar por Modelo o Código SAP:
                        </label>
                        <input
                            type="text"
                            id="model-search"
                            className="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                            placeholder="Ej: Nitro 5, ACN5-001"
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            aria-label="Buscar por Modelo de Equipo o Código SAP"
                        />
                    </div>
                </div>

                <div className="p-4 sm:p-6 lg:p-8 overflow-x-auto">
                  {/* Debugging info */}
                  {userType && (
                      <div className="mb-4 text-sm text-gray-700 p-3 bg-blue-50 rounded-lg border border-blue-200 shadow-sm">
                          <p>Datos de precios cargados: <span className="font-semibold">{priceData.length}</span> elementos</p>
                          <p>Columnas a mostrar para <span className="font-bold capitalize text-blue-700">{userType}</span>: <span className="font-semibold">{columnsToDisplay.length}</span> columnas</p>
                      </div>
                  )}
                  {/* End Debugging info */}

                  {filteredPriceData.length > 0 ? (
                    <table className="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden shadow-custom-light excel-table">
                      <thead>
                        <tr>
                          {/* Render table headers based on columnVisibility for the current userType */}
                          {columnsToDisplay.length > 0 ? (
                              columnsToDisplay.map(col => (
                                  <th key={col.key} className="py-3 px-4 text-left text-xs sm:text-sm font-semibold text-gray-700 uppercase tracking-wider border-b border-gray-200 bg-gray-100">
                                    {col.label}
                                  </th>
                              ))
                          ) : (
                              <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider border-b border-gray-200" colSpan={allColumns.length}>
                                No hay columnas para mostrar para este tipo de usuario.
                              </th>
                          )}
                        </tr>
                      </thead>
                      <tbody>
                        {filteredPriceData.map((item, index) => ( // Use filteredPriceData here
                          <tr key={item.id} className={`${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-gray-100 transition duration-150 ease-in-out`}>
                            {/* Render table cells based on columnVisibility for the current userType */}
                            {columnsToDisplay.length > 0 ? (
                                columnsToDisplay.map(col => (
                                    <td key={`${item.id}-${col.key}`} className="py-3 px-4 whitespace-nowrap text-gray-800 border-b border-gray-100 text-sm table-cell-responsive">
                                      {/* Format price columns to 2 decimal places */}
                                      {col.key.startsWith('Precio') || col.key === 'Utilidad DS'
                                        ? `$${item[col.key] ? parseFloat(item[col.key]).toFixed(2) : '0.00'}`
                                        : item[col.key]}
                                    </td>
                                ))
                            ) : (
                                <td colSpan={allColumns.length} className="py-4 text-center text-gray-500 text-sm">
                                    No hay datos de columna para mostrar para este tipo de usuario.
                                </td>
                            )}
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  ) : (
                    <p className="text-center text-gray-600 py-8 text-lg bg-gray-50 rounded-lg border border-gray-200 p-4 shadow-sm">No se encontraron resultados para los filtros aplicados. Por favor, ajusta tu búsqueda.</p>
                  )}
                </div>
              </div>
            </div>
          );
        }

        // Mount the React application to the 'root' div AFTER the window has loaded
        window.onload = function() {
            ReactDOM.createRoot(document.getElementById('root')).render(<App />);
        };
    </script>
</body>
</html>
