<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Precios</title>
    <!-- Tailwind CSS CDN (Updated to a specific, minified version - CORRECTED TAG) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/3.4.3/tailwind.min.css" rel="stylesheet">
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
    </style>

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- React CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel CDN (for JSX transformation in the browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- PapaParse CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Define the initial mock price data. This will be replaced by CSV data.
        const initialMockPriceData = [
          { id: 1, 'Tipo Equipo': 'Laptop', Marca: 'Acer', Equipo: 'Nitro 5', 'Codigo SAP': 'ACN5-001', Color: 'Negro', 'Precio Publico (IVA incluido)': 1500, 'PrecioFacturacion distribuidor (con sim e IVA Incluido)': 1200, 'Precio subdistribuidor (IVA Incluido)': 1000, 'Inicio de Vigencia': '2024-01-01', 'Fin de Vigencia': '2024-12-31', 'Utilidad DS': 0.20 },
          { id: 2, 'Tipo Equipo': 'Monitor', Marca: 'Samsung', Equipo: 'Odyssey G7', 'Codigo SAP': 'SMOG7-002', Color: 'Negro', 'Precio Publico (IVA incluido)': 400, 'PrecioFacturacion distribuidor (con sim e IVA Incluido)': 350, 'Precio subdistribuidor (IVA Incluido)': 300, 'Inicio de Vigencia': '2024-01-01', 'Fin de Vigencia': '2024-12-31', 'Utilidad DS': 0.15 },
          { id: 3, 'Tipo Equipo': 'Teclado', Marca: 'HyperX', Equipo: 'Alloy Origins', 'Codigo SAP': 'HXAO-003', Color: 'Negro', 'Precio Publico (IVA incluido)': 110, 'PrecioFacturacion distribuidor (con sim e IVA Incluido)': 95, 'Precio subdistribuidor (IVA Incluido)': 80, 'Inicio de Vigencia': '2024-01-01', 'Fin de Vigencia': '2024-12-31', 'Utilidad DS': 0.10 },
          { id: 4, 'Tipo Equipo': 'Mouse', Marca: 'Logitech', Equipo: 'G502 Hero', 'Codigo SAP': 'LGG502-004', Color: 'Negro', 'Precio Publico (IVA incluido)': 50, 'PrecioFacturacion distribuidor (con sim e IVA Incluido)': 40, 'Precio subdistribuidor (IVA Incluido)': 30, 'Inicio de Vigencia': '2024-01-01', 'Fin de Vigencia': '2024-12-31', 'Utilidad DS': 0.05 },
          { id: 5, 'Tipo Equipo': 'Auriculares', Marca: 'Razer', Equipo: 'Kraken X', 'Codigo SAP': 'RZKX-005', Color: 'Verde', 'Precio Publico (IVA incluido)': 160, 'PrecioFacturacion distribuidor (con sim e IVA Incluido)': 140, 'Precio subdistribuidor (IVA Incluido)': 120, 'Inicio de Vigencia': '2024-01-01', 'Fin de Vigencia': '2024-12-31', 'Utilidad DS': 0.12 },
        ];

        // Mock user data for authentication (for initial login with password)
        const mockUsers = [
          { username: 'admin', password: 'password123', type: 'admin' },
          { username: 'direccion', password: 'password123', type: 'direccion' },
          { username: 'distribuidor', password: 'password123', type: 'distribuidor' },
          { username: 'subdistribuidor', password: 'password123', type: 'sub distribuidor' },
        ];

        // Define column headers and their display names
        const allColumns = [
            { key: 'Tipo Equipo', label: 'Tipo Equipo' },
            { key: 'Marca', label: 'Marca' },
            { key: 'Equipo', label: 'Equipo' },
            { key: 'Codigo SAP', label: 'Código SAP' },
            { key: 'Color', label: 'Color' },
            { key: 'Precio Publico (IVA incluido)', label: 'Precio Público (IVA incluido)' },
            { key: 'PrecioFacturacion distribuidor (con sim e IVA Incluido)', label: 'Precio Facturación Distribuidor (con sim e IVA Incluido)' },
            { key: 'Precio subdistribuidor (IVA Incluido)', label: 'Precio Subdistribuidor (IVA Incluido)' },
            { key: 'Inicio de Vigencia', label: 'Inicio de Vigencia' },
            { key: 'Fin de Vigencia', label: 'Fin de Vigencia' },
            { key: 'Utilidad DS', label: 'Utilidad DS' }
        ];

        // Define column visibility rules based on user type
        const columnVisibility = {
            admin: [
                'Tipo Equipo',
                'Marca',
                'Equipo',
                'Codigo SAP',
                'Color',
                'Precio Publico (IVA incluido)',
                'PrecioFacturacion distribuidor (con sim e IVA Incluido)',
                'Precio subdistribuidor (IVA Incluido)',
                'Inicio de Vigencia',
                'Fin de Vigencia',
                'Utilidad DS'
            ],
            direccion: [
                'Marca',
                'Equipo',
                'Codigo SAP',
                'Color',
                'Precio Publico (IVA incluido)',
                'Precio subdistribuidor (IVA Incluido)',
                'Inicio de Vigencia',
                'Fin de Vigencia'
            ],
            distribuidor: [
                'Marca',
                'Equipo',
                'Codigo SAP',
                'Color',
                'Precio Publico (IVA incluido)',
                'Inicio de Vigencia',
                'Fin de Vigencia'
            ],
            'sub distribuidor': [
                'Precio Publico (IVA incluido)'
            ]
        };

        // Main App component
        function App() {
          const [userType, setUserType] = React.useState(null);
          const [username, setUsername] = React.useState('');
          const [password, setPassword] = React.useState('');
          const [error, setError] = React.useState(null);
          const [priceData, setPriceData] = React.useState(initialMockPriceData);
          const [registeredUsers, setRegisteredUsers] = React.useState([]);
          const [newUsername, setNewUsername] = React.useState('');
          const [newUserEmail, setNewUserEmail] = React.useState('');
          const [newUserPassword, setNewUserPassword] = React.useState('');
          const [newUserType, setNewUserType] = React.useState('sub distribuidor');
          const [loadingUsers, setLoadingUsers] = React.useState(true);
          const [supabaseClient, setSupabaseClient] = React.useState(null);
          const [supabaseInitError, setSupabaseInitError] = React.useState(null);

          // Supabase URL and Anon Key
          const SUPABASE_URL = 'https://tflfuxxapaxhuzvztcrm.supabase.co';
          const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmbGZ1eHhhcGF4aHV6dnp0Y3JtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1MjE1NTcsImV4cCI6MjA2ODA5NzU1N30.8Qh2wp_5qRxQNWD3coFSyu9wfOzYcn2jHREgF1-izKE';

          // Effect to initialize Supabase client
          React.useEffect(() => {
            try {
                // This check should now pass as CDN loads first
                if (typeof Supabase === 'undefined') {
                    // This error means the CDN script itself failed to load or execute
                    throw new Error("La librería global 'Supabase' no está definida. El CDN no se cargó correctamente.");
                }
                if (!SUPABASE_URL || SUPABASE_URL === 'YOUR_SUPABASE_URL' || !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                    throw new Error("Credenciales de Supabase incompletas o incorrectas. Por favor, reemplaza los marcadores de posición.");
                }
                const client = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                setSupabaseClient(client);
                console.log("Supabase cliente inicializado en React:", client);
            } catch (err) {
                console.error("Error al inicializar Supabase en React:", err);
                setSupabaseInitError(`Error al inicializar Supabase: ${err.message}. Revisa tus credenciales y la consola.`);
                setError(`Error de configuración: ${err.message}`); // Display error to user
            }
          }, []); // Run only once on component mount

          // Effect to fetch and listen to registered users from Supabase
          React.useEffect(() => {
            if (!supabaseClient) { // Use supabaseClient state variable
                console.warn("Supabase client not ready. Cannot fetch users.");
                setLoadingUsers(false);
                return;
            }

            setLoadingUsers(true);
            const channel = supabaseClient
                .from('app_users')
                .select('*')
                .on('INSERT', payload => {
                    setRegisteredUsers(prevUsers => [...prevUsers, payload.new]);
                    console.log('Nuevo usuario en tiempo real:', payload.new);
                })
                .on('UPDATE', payload => {
                    setRegisteredUsers(prevUsers => prevUsers.map(user => user.id === payload.new.id ? payload.new : user));
                    console.log('Usuario actualizado en tiempo real:', payload.new);
                })
                .on('DELETE', payload => {
                    setRegisteredUsers(prevUsers => prevUsers.filter(user => user.id !== payload.old.id));
                    console.log('Usuario eliminado en tiempo real:', payload.old);
                })
                .subscribe();

            // Initial fetch of users
            const fetchInitialUsers = async () => {
                const { data, error } = await supabaseClient.from('app_users').select('*');
                if (error) {
                    console.error("Error al cargar usuarios desde Supabase:", error);
                    setError(`Error al cargar usuarios: ${error.message}. Revisa las políticas de RLS de Supabase.`);
                } else {
                    setRegisteredUsers(data);
                    console.log("Usuarios cargados desde Supabase:", data);
                }
                setLoadingUsers(false);
            };

            fetchInitialUsers();

            // Cleanup subscription on component unmount
            return () => {
                if (supabaseClient) {
                    supabaseClient.removeChannel(channel);
                }
            };
          }, [supabaseClient]); // Re-run when supabaseClient is ready

          // Handle login attempt
          const handleLogin = async (e) => {
            e.preventDefault();
            setError(null); // Clear previous errors

            if (!supabaseClient) {
                setError("El cliente Supabase no está inicializado. No se puede iniciar sesión.");
                return;
            }

            // 1. Try logging in with mock users first (for hardcoded admin, direccion, etc.)
            const mockUser = mockUsers.find(u => u.username === username && u.password === password);
            if (mockUser) {
              setUserType(mockUser.type);
              setError(null);
              return;
            }

            // 2. If not a mock user, try logging in with Supabase Auth (assuming username is email)
            try {
                const { data, error: authError } = await supabaseClient.auth.signInWithPassword({
                    email: username,
                    password: password,
                });

                if (authError) {
                    setError(`Error de inicio de sesión: ${authError.message}`);
                    return;
                }

                // If Supabase login successful, fetch user type from app_users table
                const { data: profile, error: profileError } = await supabaseClient
                    .from('app_users')
                    .select('type')
                    .eq('id', data.user.id)
                    .single();

                if (profileError) {
                    console.error("Error al obtener el perfil del usuario desde Supabase:", profileError);
                    setError("Inicio de sesión exitoso, pero no se pudo cargar el tipo de usuario.");
                    setUserType('sub distribuidor'); // Fallback to a default type
                    return;
                }

                setUserType(profile.type);
                setError(null);

            } catch (e) {
                console.error("Error inesperado durante el inicio de sesión:", e);
                setError("Ocurrió un error inesperado durante el inicio de sesión.");
            }
          };

          // Handle logout
          const handleLogout = async () => {
            if (supabaseClient) {
                const { error } = await supabaseClient.auth.signOut();
                if (error) {
                    console.error("Error al cerrar sesión en Supabase:", error);
                }
            }
            setUserType(null);
            setUsername('');
            setPassword('');
            setError(null);
            setPriceData(initialMockPriceData);
            setNewUsername('');
            setNewUserEmail('');
            setNewUserPassword('');
            setNewUserType('sub distribuidor');
          };

          // Handle CSV file upload
          const handleFileUpload = (event) => {
            const file = event.target.files[0];
            if (file) {
              Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                  const requiredHeaders = [
                    'Tipo Equipo', 'Marca', 'Equipo', 'Codigo SAP', 'Color',
                    'Precio Publico (IVA incluido)', 'PrecioFacturacion distribuidor (con sim e IVA Incluido)',
                    'Precio subdistribuidor (IVA Incluido)', 'Inicio de Vigencia', 'Fin de Vigencia', 'Utilidad DS'
                  ];
                  const actualHeaders = results.meta.fields;

                  const missingHeaders = requiredHeaders.filter(header => !actualHeaders.includes(header));

                  if (missingHeaders.length > 0) {
                    setError(`Error en el CSV: Faltan las siguientes columnas: ${missingHeaders.join(', ')}. Asegúrate de que los nombres de las columnas coincidan exactamente.`);
                    setPriceData(initialMockPriceData);
                    return;
                  }

                  const parsedData = results.data.map((row, index) => ({
                    id: index + 1,
                    'Tipo Equipo': row['Tipo Equipo'],
                    Marca: row['Marca'],
                    Equipo: row['Equipo'],
                    'Codigo SAP': row['Codigo SAP'],
                    Color: row['Color'],
                    'Precio Publico (IVA incluido)': parseFloat(row['Precio Publico (IVA incluido)']) || 0,
                    'PrecioFacturacion distribuidor (con sim e IVA Incluido)': parseFloat(row['PrecioFacturacion distribuidor (con sim e IVA Incluido)']) || 0,
                    'Precio subdistribuidor (IVA Incluido)': parseFloat(row['Precio subdistribuidor (IVA Incluido)']) || 0,
                    'Inicio de Vigencia': row['Inicio de Vigencia'],
                    'Fin de Vigencia': row['Fin de Vigencia'],
                    'Utilidad DS': parseFloat(row['Utilidad DS']) || 0,
                  }));

                  if (parsedData.length > 0) {
                    setPriceData(parsedData);
                    setError(null);
                  } else {
                    setError('El archivo CSV está vacío o no contiene datos válidos.');
                    setPriceData(initialMockPriceData);
                  }
                },
                error: (err) => {
                  setError(`Error al parsear el archivo CSV: ${err.message}`);
                  setPriceData(initialMockPriceData);
                }
              });
            }
          };

          // Handle creating a new user (Admin only)
          const handleCreateUser = async () => {
            if (!supabaseClient) {
                setError("El cliente Supabase no está inicializado. No se puede crear el usuario.");
                return;
            }
            if (!newUsername || !newUserEmail || !newUserPassword) {
              setError('Todos los campos (usuario, email, contraseña) son obligatorios.');
              return;
            }
            if (mockUsers.some(u => u.username === newUsername) || registeredUsers.some(u => u.username === newUsername)) {
              setError('Este nombre de usuario ya existe. Por favor, elige otro.');
              return;
            }

            try {
              // 1. Create user in Supabase Auth
              const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                email: newUserEmail,
                password: newUserPassword,
                options: {
                    data: {
                        username: newUsername,
                        user_type: newUserType
                    }
                }
              });

              if (authError) {
                setError(`Error al registrar usuario en Supabase Auth: ${authError.message}`);
                return;
              }
              // Supabase automatically inserts into auth.users. Now insert into app_users table.
              if (authData.user) {
                  const { data: profileData, error: profileError } = await supabaseClient.from('app_users').insert([
                    { id: authData.user.id, username: newUsername, type: newUserType }
                  ]);

                  if (profileError) {
                    console.error("Error al insertar perfil de usuario en app_users:", profileError);
                    // Consider rolling back the auth.signUp if profile creation fails
                    setError(`Error al crear el perfil de usuario: ${profileError.message}`);
                    return;
                  }
              }


              setNewUsername('');
              setNewUserEmail('');
              setNewUserPassword('');
              setNewUserType('sub distribuidor');
              setError(null);
              console.log("Usuario creado con éxito en Supabase Auth y app_users.");
            } catch (e) {
              console.error("Error inesperado al crear usuario:", e);
              setError("Ocurrió un error inesperado al crear el usuario.");
            }
          };

          // Get the columns to display based on the current userType
          const columnsToDisplay = userType ? allColumns.filter(col => columnVisibility[userType] && columnVisibility[userType].includes(col.key)) : [];

          // Render the login form if no user is logged in
          if (!userType) {
            return (
              <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-600 p-4 font-inter">
                <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
                  <h2 className="text-3xl font-bold text-center text-gray-800 mb-8">Iniciar Sesión</h2>
                  {error && ( // Display general error message
                      <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mb-4" role="alert">
                          <strong className="font-bold">Error:</strong>
                          <span className="block sm:inline"> {error}</span>
                      </div>
                  )}
                  {supabaseInitError && ( // Display specific Supabase init error
                      <div className="bg-orange-100 border border-orange-400 text-orange-700 px-4 py-3 rounded-md mb-4" role="alert">
                          <strong className="font-bold">Configuración Supabase:</strong>
                          <span className="block sm:inline"> {supabaseInitError}</span>
                      </div>
                  )}
                  <form onSubmit={handleLogin}>
                    <div className="mb-6">
                      <label htmlFor="username" className="block text-gray-700 text-sm font-semibold mb-2">
                        Usuario (o Email para usuarios Supabase)
                      </label>
                      <input
                        type="text"
                        id="username"
                        className="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                        value={username}
                        onChange={(e) => setUsername(e.target.value)}
                        required
                      />
                    </div>
                    <div className="mb-6">
                      <label htmlFor="password" className="block text-gray-700 text-sm font-semibold mb-2">
                        Contraseña
                      </label>
                      <input
                        type="password"
                        id="password"
                        className="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        required
                      />
                    </div>
                    <button
                      type="submit"
                      className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition duration-300 ease-in-out transform hover:scale-105"
                    >
                      Entrar
                    </button>
                  </form>
                  <p className="text-center text-gray-600 text-sm mt-6">
                    <span className="font-semibold">Usuarios de prueba (hardcoded):</span>
                    <br />
                    admin / password123 (Administrador)
                    <br />
                    direccion / password123 (Dirección)
                    <br />
                    distribuidor / password123 (Distribuidor)
                    <br />
                    subdistribuidor / password123 (Sub Distribuidor)
                    <br />
                    <span className="font-semibold text-blue-700">Para usuarios creados por el administrador:</span> usa el email y la contraseña que definiste al crearlos.
                  </p>
                </div>
              </div>
            );
          }

          // Render the price list if a user is logged in
          return (
            <div className="min-h-screen bg-gray-100 p-4 sm:p-6 lg:p-8 font-inter">
              <div className="max-w-7xl mx-auto bg-white rounded-xl shadow-xl overflow-hidden">
                <header className="bg-gradient-to-r from-blue-600 to-purple-700 p-6 flex flex-col sm:flex-row justify-between items-center text-white">
                  <h1 className="text-3xl font-extrabold mb-4 sm:mb-0">Lista de Precios</h1>
                  <div className="flex items-center space-x-4">
                    <span className="text-lg">Bienvenido, <span className="font-bold capitalize">{userType}</span>!</span>
                    <button
                      onClick={handleLogout}
                      className="bg-white text-blue-600 hover:bg-blue-100 font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105"
                    >
                      Cerrar Sesión
                    </button>
                  </div>
                </header>

                {userType === 'admin' && (
                  <div className="p-4 sm:p-6 lg:p-8 bg-gray-50 border-b border-gray-200 flex flex-col gap-6">
                    <h3 className="text-2xl font-bold text-gray-800 mb-4">Gestión de Usuarios</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                      <div>
                        <label htmlFor="new-username" className="block text-gray-700 text-sm font-semibold mb-2">
                          Nombre de Usuario
                        </label>
                        <input
                          type="text"
                          id="new-username"
                          className="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                          value={newUsername}
                          onChange={(e) => setNewUsername(e.target.value)}
                          placeholder="Ej: juan.perez"
                        />
                      </div>
                      <div>
                        <label htmlFor="new-user-email" className="block text-gray-700 text-sm font-semibold mb-2">
                          Email
                        </label>
                        <input
                          type="email"
                          id="new-user-email"
                          className="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                          value={newUserEmail}
                          onChange={(e) => setNewUserEmail(e.target.value)}
                          placeholder="Ej: juan.perez@dominio.com"
                        />
                      </div>
                      <div>
                        <label htmlFor="new-user-password" className="block text-gray-700 text-sm font-semibold mb-2">
                          Contraseña
                        </label>
                        <input
                          type="password"
                          id="new-user-password"
                          className="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                          value={newUserPassword}
                          onChange={(e) => setNewUserPassword(e.target.value)}
                          placeholder="Contraseña segura"
                        />
                      </div>
                      <div>
                        <label htmlFor="new-user-type" className="block text-gray-700 text-sm font-semibold mb-2">
                          Tipo de Usuario
                        </label>
                        <select
                          id="new-user-type"
                          className="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                          value={newUserType}
                          onChange={(e) => setNewUserType(e.target.value)}
                        >
                          <option value="sub distribuidor">Sub Distribuidor</option>
                          <option value="distribuidor">Distribuidor</option>
                          <option value="direccion">Dirección</option>
                          <option value="admin">Administrador</option>
                        </select>
                      </div>
                      <div className="flex items-end col-span-1 md:col-span-2 lg:col-span-1">
                        <button
                          onClick={handleCreateUser}
                          className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition duration-300 ease-in-out transform hover:scale-105"
                        >
                          Crear Usuario
                        </button>
                      </div>
                    </div>
                    {error && <p className="text-red-500 text-sm text-center mb-4">{error}</p>}

                    <h4 className="text-xl font-bold text-gray-700 mb-2">Usuarios Registrados</h4>
                    <div className="overflow-x-auto">
                      {loadingUsers ? (
                        <p className="text-center text-gray-600 py-4">Cargando usuarios...</p>
                      ) : (
                        <table className="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden">
                          <thead className="bg-gray-50">
                            <tr>
                              <th className="py-2 px-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider border-b">
                                Usuario
                              </th>
                              <th className="py-2 px-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider border-b">
                                Email
                              </th>
                              <th className="py-2 px-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider border-b">
                                Tipo
                              </th>
                              <th className="py-2 px-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider border-b">
                                ID (Supabase)
                              </th>
                            </tr>
                          </thead>
                          <tbody>
                            {/* Display mock users first (they don't have Supabase IDs) */}
                            {mockUsers.map((user, index) => (
                              <tr key={`mock-${index}`} className={`${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-gray-100 transition duration-150`}>
                                <td className="py-2 px-3 whitespace-nowrap text-gray-800 border-b">{user.username}</td>
                                <td className="py-2 px-3 whitespace-nowrap text-gray-700 border-b">N/A</td>
                                <td className="py-2 px-3 whitespace-nowrap text-gray-700 border-b capitalize">{user.type}</td>
                                <td className="py-2 px-3 whitespace-nowrap text-gray-500 text-xs border-b">N/A (Mock)</td>
                              </tr>
                            ))}
                            {/* Display users from Supabase */}
                            {registeredUsers.map((user, index) => (
                              <tr key={user.id} className={`${(mockUsers.length + index) % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-gray-100 transition duration-150`}>
                                <td className="py-2 px-3 whitespace-nowrap text-gray-800 border-b">{user.username}</td>
                                <td className="py-2 px-3 whitespace-nowrap text-gray-700 border-b">{user.email || 'N/A'}</td>
                                <td className="py-2 px-3 whitespace-nowrap text-gray-700 border-b capitalize">{user.type}</td>
                                <td className="py-2 px-3 whitespace-nowrap text-gray-500 text-xs border-b">{user.id}</td>
                              </tr>
                            ))}
                            {registeredUsers.length === 0 && mockUsers.length === 0 && (
                              <tr>
                                <td colSpan="4" className="py-4 text-center text-gray-500">No hay usuarios registrados.</td>
                              </tr>
                            )}
                          </tbody>
                        </table>
                      )}
                    </div>
                  </div>
                )}

                <div className="p-4 sm:p-6 lg:p-8 bg-gray-50 border-b border-gray-200 flex flex-col sm:flex-row items-center justify-between gap-4">
                  <label htmlFor="csv-upload" className="block text-gray-700 text-sm font-semibold">
                    Cargar archivo CSV:
                  </label>
                  <input
                    type="file"
                    id="csv-upload"
                    accept=".csv"
                    onChange={handleFileUpload}
                    className="block w-full sm:w-auto text-sm text-gray-500
                      file:mr-4 file:py-2 file:px-4
                      file:rounded-lg file:border-0
                      file:text-sm file:font-semibold
                      file:bg-blue-50 file:text-blue-700
                      hover:file:bg-blue-100 transition duration-200"
                  />
                  {error && <p className="text-red-500 text-sm text-center sm:text-right mt-2 sm:mt-0">{error}</p>}
                </div>

                <div className="p-4 sm:p-6 lg:p-8 overflow-x-auto">
                  {/* Debugging info */}
                  {userType && (
                      <div className="mb-4 text-sm text-gray-700">
                          <p>Datos de precios cargados: {priceData.length} elementos</p>
                          <p>Columnas a mostrar para <span className="capitalize font-semibold">{userType}</span>: {columnsToDisplay.length} columnas</p>
                      </div>
                  )}
                  {/* End Debugging info */}

                  {priceData.length > 0 ? (
                    <table className="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden">
                      <thead className="bg-gray-50">
                        <tr>
                          {/* Render table headers based on columnVisibility for the current userType */}
                          {columnsToDisplay.length > 0 ? (
                              allColumns.map(col => (
                                columnsToDisplay.some(visibleColKey => visibleColKey === col.key) && (
                                  <th key={col.key} className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider border-b">
                                    {col.label}
                                  </th>
                                )
                              ))
                          ) : (
                              <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider border-b" colSpan={allColumns.length}>
                                No hay columnas para mostrar para este tipo de usuario.
                              </th>
                          )}
                        </tr>
                      </thead>
                      <tbody>
                        {priceData.map((item, index) => (
                          <tr key={item.id} className={`${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-gray-100 transition duration-150`}>
                            {/* Render table cells based on columnVisibility for the current userType */}
                            {columnsToDisplay.length > 0 ? (
                                allColumns.map(col => (
                                  columnsToDisplay.some(visibleColKey => visibleColKey === col.key) && (
                                    <td key={`${item.id}-${col.key}`} className="py-3 px-4 whitespace-nowrap text-gray-800 border-b">
                                      {/* Format price columns to 2 decimal places */}
                                      {col.key.startsWith('Precio') || col.key === 'Utilidad DS'
                                        ? `$${item[col.key] ? parseFloat(item[col.key]).toFixed(2) : '0.00'}`
                                        : item[col.key]}
                                    </td>
                                  )
                                ))
                            ) : (
                                <td colSpan={allColumns.length} className="py-4 text-center text-gray-500">
                                    No hay datos de columna para mostrar para este tipo de usuario.
                                </td>
                            )}
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  ) : (
                    <p className="text-center text-gray-600 py-8">No hay datos de precios para mostrar. Por favor, carga un archivo CSV.</p>
                  )}
                </div>
              </div>
            </div>
          );
        }

        // Mount the React application to the 'root' div AFTER the window has loaded
        window.onload = function() {
            // Final check before rendering React app
            if (typeof Supabase === 'undefined') {
                const rootDiv = document.getElementById('root');
                if (rootDiv) {
                    rootDiv.innerHTML = `
                        <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background-color: #fef2f2; color: #ef4444; padding: 20px; text-align: center; font-family: 'Inter', sans-serif; border: 1px solid #ef4444; border-radius: 8px; margin: 20px;">
                            <p>
                                <strong>Error Crítico:</strong> La librería de Supabase no se ha cargado correctamente.
                                <br/>
                                Por favor, revisa tu conexión a internet y las herramientas de desarrollador del navegador (pestaña "Network")
                                para asegurarte de que el CDN de Supabase (<code style="background-color: #fee2e2; padding: 2px 4px; border-radius: 4px;">https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2</code>)
                                se esté cargando sin errores.
                            </p>
                        </div>
                    `;
                }
                console.error("Critical Error: Supabase library is not loaded. Cannot render React application.");
            } else {
                ReactDOM.createRoot(document.getElementById('root')).render(<App />);
            }
        };
    </script>
</body>
</html>
